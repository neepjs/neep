/*!
 * Neep v0.1.0-alpha.12
 * (c) 2019-2020 Fierflame
 * @license MIT
 */
const e="0.1.0-alpha.12",t=!0;function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class r extends Error{constructor(e,t=""){super(t?`[${t}] ${e}`:e),n(this,"tag",void 0),this.tag=t}}let o;function i(e){!function(e,t,n){if(!e)throw new r(t,n)}(o,"The basic renderer is not installed","install"),o&&o(e)}const s=Object.create(null);function c(e=""){return"object"==typeof e?e:s[e]||s.default}let d,a,l,u,f,h,p,y,v,m,g,_;function w(e){var t;(t=e.monitorable)&&({value:d,computed:a,isValue:l,encase:u,recover:f,valueify:h,markRead:p,markChange:y,safeify:v,asValue:m,exec:g,monitor:_}=t),function(e){e&&(s[e.type]=e,o||(s.default||(s.default=e),!o&&e.nextFrame&&(s.default=e,o=e.nextFrame)))}(e.render)}function b(e){return"@"===e[0]?e.substr(1):/^on[:-]/.test(e)?e.substr(3):/^n([:-])on(\1|:)/.test(e)?e.substr(5):""}function R(e,t){if(t)if("function"!=typeof t){if("object"==typeof t)for(const n of Object.keys(t)){const r=t[n];"function"==typeof r&&e(n,r)}}else{const{names:n}=t;if(!Array.isArray(n))return;for(const r of n)r&&e(r,(...e)=>t(r,...e))}}class x{static update(e,t){if(!t)return[];const n=[];if(t&&"object"==typeof t)for(const r of Object.keys(t)){if(!r)continue;const o=t[r];"function"==typeof o&&n.push(e.on(r,o))}return n}static updateInProps(e,t,n){if(!t)return[];const r=[];function o(t,n){r.push(e.on(t,n))}for(const e of Object.keys(t)){const n=t[e];if("function"!=typeof n)continue;const r=b(e);r&&o(r,n)}return R(o,t["@"]),R(o,t["n:on"]),R(o,t["n-on"]),"function"==typeof n&&n(o),r.push(...x.update(e,t["@"])),r}get names(){return[...this._names]}constructor(){n(this,"_names",new Set),n(this,"_cancelHandles",new Set),n(this,"emit",void 0),n(this,"on",void 0);const e=Object.create(null),t=this._names;function r(...n){function o(t,...n){const r=e[t];if(!r)return!0;let o=!0;for(const e of[...r])o=e(...n)&&o;return o}return o.omit=(...e)=>r(...n,...e),Reflect.defineProperty(o,"names",{get:()=>(p(r,"names"),[...t].filter(e=>!n.includes(e))),configurable:!0}),o}this.emit=r(),this.on=(n,o)=>{var i;function s(...e){try{return!1!==o(...e)}catch(e){return console.error(e),!1}}let c=e[n];(null===(i=c)||void 0===i?void 0:i.size)||(c=new Set,e[n]=c,y(r,"names"),t.add(n)),c.add(s);let d=!1;return()=>{d||(d=!0,c.delete(s),c.size||(y(r,"names"),t.delete(n)))}}}updateHandles(e){const t=this._cancelHandles,n=[...t];t.clear();for(const e of n)e();return e.forEach(e=>t.add(e)),e}update(e){const t=x.update(this,e);return this.updateHandles(t)}updateInProps(e,t){const n=x.updateInProps(this,e,t);return this.updateHandles(n)}}const k="Neep:ScopeSlot",A="Neep:SlotRender",D="Neep:Slot",N="Neep:Value",$="Neep:Container",C="Neep:Deliver",S="template",j=S;let O;function H(e,t){const n=O;O=t;try{O.$_valueIndex=0,O.$_serviceIndex=0;const t=e();if(O.$_valueIndex!==O.$_values.length)throw new r("Inconsistent number of useValue executions","life");if(O.$_serviceIndex&&O.$_serviceIndex!==O.$_services.length)throw new r("Inconsistent number of useService executions","life");return t}finally{O=n}}function P(e,t=!1){if(!O)throw new r(`Function \`${e}\` can only be called within a cycle.`,"life");if(!t)return O;if(!O.created)return O;throw new r(`Function \`${e}\` can only be called at initialization time.`,"life")}const I=[];function T(e,t){for(const n of I)n(e,t);return e}function E(e){I.push(v(e))}let M=0;const q=new Set;function z(e){return!(M<=0)&&(q.add(e),!0)}function V(){if(M>0)return;const e=[...q];q.clear(),e.forEach(e=>e.refresh())}function K(e,t){if(t)return async function(e){try{return M++,await e()}finally{M--,V()}}(e);try{return M++,e()}finally{M--,V()}}const L=Object.create(null);function B(e,t,n){let r=(null==n?void 0:n.$_hooks)||L;if(!r)return()=>{};t=v(t);let o=r[e];return o||(o=new Set,r[e]=o),o.add(t),()=>o.delete(t)}function F(e,t){if(t){for(const n of t.$_hooks[e]||[])n(t);for(const n of L[e]||[])n(t)}}function U(e,t){const n=P("watch");if("function"!=typeof e)return()=>{};const r=l(e)?e.watch(t):a(e).watch((e,n)=>t(e(),n));return B("beforeDestroy",()=>r(),n),r}function G(e){const t=P("useValue"),n=t.$_valueIndex++,o=t.$_values;if(!t.created){o[n]=void 0;const t="function"==typeof e?e():d(void 0);return o[n]=t}if(n>=o.length)throw new r("Inconsistent number of useValue executions","life");return o[n]}function J(e){const t=P("useService"),n=t.$_serviceIndex++,o=t.$_services;if(!t.created){o[n]=void 0;const r=e(t);return o[n]=r,r}if(n>=o.length)throw new r("Inconsistent number of useService executions","life");return o[n]}function Q(e,t,n){const r=P("setHook");if(!n||!r.created)return B(e,()=>t(),r)}function W(e,t,n,r){"string"==typeof t&&["$","_"].includes(t[0])||(l(n)&&r?Reflect.defineProperty(e,t,{get:()=>n(),set(e){n(e)},configurable:!0,enumerable:!0}):"function"==typeof n&&r?Reflect.defineProperty(e,t,{get:n,set:"function"==typeof r?r:void 0,configurable:!0,enumerable:!0}):Reflect.defineProperty(e,t,{get:()=>n,configurable:!0,enumerable:!0}))}function X(e,t,n){W(P("expose",!0).exposed,e,t,n)}function Y(e,t,n){W(P("deliver",!0).delivered,e,t,n)}const Z=Symbol.for("isNeepElement"),ee=Symbol.for("type"),te=Symbol.for("name"),ne=Symbol.for("render"),re=Symbol.for("components"),oe=Symbol.for("config");function ie(e){return!!e&&("object"==typeof e&&!0===e[Z])}function se(e,t,...n){t=t?{...t}:{};const r={[Z]:!0,tag:e,key:void 0,children:[]};if("n:key"in t?r.key=t.key:"n-key"in t&&(r.key=t.key),"slot"in t&&(r.slot=t.slot),"function"==typeof t.ref&&(r.ref=t.ref),e===N)return r.value=t.value,r;if(r.children=n,e===S)return r;if("Neep:SlotRender"===e)return r.render=t.render,r;if(e===k||e===D){const{render:n,argv:o,args:i,name:s}=t;if(r.render=n,r.args=o&&[o]||Array.isArray(i)&&i.length&&i||[{}],e===k)return r.props={name:s},r}r.props={};for(let e in t)r.props[e]=t[e];return r}function ce(e,t={}){if(Array.isArray(e)){const n=[];for(let r of e)n.push(ce(r,t));return[].concat(...n)}if(!ie(e))return[e];let{tag:n}=e;if(!n)return[e];if([S,k].includes(n))return ce(e.children,t);if("function"!=typeof n)return[e];if("simple"!==n[ee])return[e];const{simple:r=!0}=t;if(!r)return[e];if(Array.isArray(r)){if(r.includes(n))return[e]}else if("function"==typeof r&&!r(n))return[e];return ce(e.children,t)}function de(e,t=""){}function ae(e){for(const t of Object.keys(s)){const n=s[t];if(!n)continue;if(!n.isNode(e))continue;const r=n.getRect(e);if(r)return r}return null}function le(e,t){return{...e,id:0}}function*ue(e){if(Array.isArray(e))for(const t of e)yield*ue(t);else yield e}let fe;function he(e){fe=e}function pe(e,t,n){"function"==typeof e&&t&&(fe?fe.push(()=>e(t,n)):e(t,n))}function*ye(e){if(Array.isArray(e)){for(const t of e)yield*ye(t);return}const{children:t,node:n,component:r}=e;n?yield n:r?yield*ye(r.tree):yield*ye(t)}function ve(e,t){if(Array.isArray(t))return void t.forEach(t=>ve(e,t));const{component:n,children:r,node:o,ref:i}=t;if(n)return pe(i,n.exposed,!0),void n.unmount();o&&(pe(i,o,!0),e.removeNode(o)),ve(e,r)}function me(e,t,n){let{ref:r}=t;if(e.isNode(n))return pe(r,n),le({...t,value:n,node:n,children:[],component:void 0});const o=typeof n;let i;return"bigint"===o||"boolean"===o||"number"===o||"string"===o||"symbol"===o||n instanceof RegExp?i=e.createText(String(n)):n instanceof Date?i=e.createText(n.toISOString()):"object"===o&&n&&(i=e.createText(String(n))),i||(i=e.createPlaceholder()),pe(r,i),le({...t,value:n,node:i,component:void 0,children:[]})}function ge(e,t){return t.length?t.map(t=>Array.isArray(t)?_e(e,t):we(e,t)):[le({tag:null,node:e.createPlaceholder(),component:void 0,children:[]})]}function _e(e,t){return t.length?t.map(t=>we(e,t)):[le({tag:null,node:e.createPlaceholder(),component:void 0,children:[]})]}function we(e,t){var n;const{tag:r,ref:o,component:i}=t;if(!r){const t=e.createPlaceholder();return pe(o,t),le({tag:null,node:t,component:void 0,children:[]})}const s="string"!=typeof r?"":r.toLowerCase();if("string"!=typeof r||"neep:container"===s)return i?(i.mount(),pe(o,i.exposed),le({...t,node:void 0,component:i,children:[]})):le({...t,node:void 0,component:void 0,children:ge(e,t.children)});if("neep:value"===s){let{value:n}=t;return l(n)&&(n=n()),me(e,t,n)}if("neep:"===s.substr(0,5)||"template"===s)return le({...t,node:void 0,component:void 0,children:ge(e,t.children)});const c=e.createElement(r,t.props||{});pe(o,c);let d=[];if(null===(n=t.children)||void 0===n?void 0:n.length){d=ge(e,t.children);for(const t of ye(d))e.insertNode(c,t)}return le({...t,node:c,component:void 0,children:d})}function be(e){if(Array.isArray(e))return be(e[e.length-1]);const{component:t,children:n,node:r}=e;return r||be(t?t.tree:n)}function Re(e){if(Array.isArray(e))return Re(e[0]);const{component:t,children:n,node:r}=e;return r||Re(t?t.tree:n[0])}function xe(e,t,n){const r=Re(n);if(!r)return t;const o=e.getParent(r);if(!o)return t;for(const n of ye(t))e.insertNode(o,n,r);return ve(e,n),t}function ke(e,t,n){if(!t.length){return[xe(e,we(e,{tag:null,children:[]}),n)]}Array.isArray(n)||(n=[n]);const r=[],o=[...n],i=new Map;for(const n of t){const t=o.findIndex(e=>e.tag===n.tag&&e.key===n.key);if(t>=0){const s=o[t],c=De(e,n,s);i.set(s,c),r.push(c),o.splice(t,1)}else{const t=we(e,n);r.push(t)}}if(!i.size)return xe(e,r,o);ve(e,o);const s=be((n=n.filter(e=>i.has(e)))[n.length-1]),c=e.getParent(s);if(!c)return r;let d=e.nextNode(s);for(let t=r.length-1;t>=0;t--){const o=r[t],s=n.findIndex(e=>i.get(e)===o);if(s>=0)for(const e of n.splice(s))i.delete(e);else for(const t of ye(o))e.insertNode(c,t,d);d=Re(o)||d}return r}function Ae(e,t,n){let r=0,o=Math.min(t.length,t.length||1);const i=[];for(;r<o;r++){const o=t[r];Array.isArray(o)?i.push(ke(e,o,n[r])):i.push(De(e,o,n[r]))}if(o=Math.max(t.length,n.length),n.length>o)for(;r<o;r++)ve(e,n[r]);if(t.length>o){const n=be(i[i.length-1]),s=e.getParent(n),c=e.nextNode(n);for(;r<o;r++){const n=t[r],o=Array.isArray(n)?_e(e,n):we(e,n);if(i.push(o),s)for(const t of ye(o))e.insertNode(s,t,c)}}return i}function De(e,t,n){if(Array.isArray(n)){const r=n.findIndex(e=>e.tag===t.tag&&e.component===t.component);if(r<0)return xe(e,we(e,t),n);const o=n;[n]=n.splice(r,1),ve(e,o)}const{tag:r,component:o}=t,i=t.ref!==n.ref&&t.ref||void 0;if(r!==n.tag||o!==n.component)return xe(e,we(e,t),n);if(!r)return n;const s="string"!=typeof r?"":r.toLowerCase();if("string"!=typeof r||"neep:container"===s)return o?(pe(i,o.exposed),le({...t,node:void 0,component:o,children:[]},n.id)):le({...t,node:void 0,component:void 0,children:Ae(e,t.children,n.children)},n.id);if("neep:value"===s){let{value:r}=t;return l(r)&&(r=r()),n.value===r?(pe(i,n.node),le({...n,...t,value:r,children:[]},n.id)):xe(e,me(e,t,r),n)}if("neep:"===s.substr(0,5)||"template"===s)return le({...t,node:void 0,component:void 0,children:Ae(e,t.children,n.children)},n.id);const{node:c}=n;if(e.updateProps(c,t.props||{}),pe(i,c),!t.children.length&&!n.children.length)return le({...n,...t,children:[]},n.id);if(!t.children.length&&n.children.length&&ve(e,n.children),t.children.length&&!n.children.length){const r=ge(e,t.children);for(const t of ye(r))e.insertNode(c,t);return le({...n,...t,children:r},n.id)}return le({...n,...t,children:Ae(e,t.children,n.children)},n.id)}function Ne(e,t,n){return n?Ae(e,t,n):ge(e,t)}function $e(e,t,n,r=!1){const o=[];for(const i of t){if(Array.isArray(i)){const t=Object.create(null);o.push($e(e,i,t,r));for(const e of Reflect.ownKeys(t))e in n?n[e].push(t[e]):n[e]=[t[e]];continue}if(r){if(e.isNode(i)){o.push(i);continue}if(!ie(i)){o.push(i);continue}if("Neep:SlotRender"!==i.tag){o.push(i);continue}}const t=ie(i)&&i.slot||"default",s=ie(i)?{...i,slot:void 0,props:{...i.props,slot:void 0}}:i;t in n?n[t].push(s):n[t]=[s]}return o}function Ce(e,...t){return e.map(e=>Array.isArray(e)?Ce(e,...t):ie(e)?"Neep:SlotRender"!==e.tag?{...e,slot:void 0}:"function"==typeof e.render?e.render(...t):e.children:e)}function Se(e,t){const n=(...e)=>({[Z]:!0,tag:k,children:Ce(t,...e),inserted:!0,label:void 0});return n.children=t,n}function je(e,t=Object.create(null)){for(const n of Reflect.ownKeys(t))n in e||delete t[n];for(const n of Reflect.ownKeys(e))t[n]=Se(0,e[n]);return t}const Oe=new Set([":","@","#","*","!","%","^","~","&","=","+",".","(",")","[","]","{","}","<",">"]);function He(e){return"string"!=typeof e||!Oe.has(e[0])&&(!/^n[:-]/.test(e)&&!/^on[:-]/.test(e))}function Pe(e,t,n={},r=!1,o=!1){const i=Reflect.ownKeys(t),s=new Set(o?i.filter(He):i);for(const t of Reflect.ownKeys(e))s.has(t)||delete e[t];if(!r){for(const n of s)e[n]=t[n];return e}for(const r of s){const o=t[r];r in n&&n[r]===o||(l(o)?Reflect.defineProperty(e,r,{configurable:!0,enumerable:!0,get:()=>o(),set(e){o(e)}}):Reflect.defineProperty(e,r,{configurable:!0,enumerable:!0,value:o}))}return e}const Ie=Object.create(null);function Te(e,t){Ie[e]=t}function Ee(...e){return e.filter(Boolean)}function Me(e,t){if(!e)return null;if("string"!=typeof e)return e;if("template"===e)return e;if(/^neep:.+/i.test(e))return e;for(const n of t){const t=n[e];if(t)return t}return Ie[e]||e}function qe(e,t,n,r,o,i){const{inserted:s,args:c=[{}]}=n;let d=Me(n.tag,o);if("Neep:Deliver"===d){const s={...n.props};return delete s.ref,delete s.slot,delete s.key,{...n,tag:d,children:n.children.map(n=>ze(e,Pe(Object.create(t),s||{},{},!0),n,r,o,i))}}const a=n.children.map(n=>ze(e,t,n,r,o,i));return"function"==typeof d?"simple"===d[ee]?function(e,t,n,r,o,i){if(n.execed)return n;const{iRender:s}=e,c=Object.create(null);$e(s,i,c);const d=je(c),a=new x;a.updateInProps(n.props);const l={...n.props},u=T({slots:d,created:!1,parent:e.exposed,delivered:t,children:new Set,childNodes:i,refresh(t){e.refresh(t)},emit:a.emit}),f=r(l,u),h=ze(e,t,Ve(s,f,u,r[ne]),d,Ee(...o,r[re]),!1);return{...n,tag:r,execed:!0,children:Array.isArray(h)?h:[h],label:void 0}}(e,t,n,d,o,ze(e,t,a,r,o,i)):{...n,children:a,tag:d}:(d===D&&(d=i?"slot":k),d!==k||s?{...n,children:a,tag:d}:function(e,t,n,r,o,i,s=[{}],c){var d;const a=r[(null===(d=n.props)||void 0===d?void 0:d.name)||"default"];if("function"==typeof a)return{...n,...a(...s)};const{render:l}=n;return{...n,tag:k,label:void 0,children:ze(e,t,"function"!=typeof l?i:l(...s),r,o,c)}}(e,t,{...n,tag:d},r,o,a,c,i))}function ze(e,t,n,r,o,i){return Array.isArray(n)?n.map(n=>ze(e,t,n,r,o,i)):ie(n)?qe(e,t,n,r,o,i):n}function Ve(e,t,n,r){return Array.isArray(t)?t:ie(t)?[t]:null==t?[{[Z]:!0,tag:null,key:void 0,children:[]}]:(!e.isNode(t)&&t&&"object"==typeof t&&r&&(t=r(t,n)),ie(t)?[t]:null==t?[{[Z]:!0,tag:null,key:void 0,children:[]}]:[{[Z]:!0,key:void 0,tag:N,value:t,children:[]}])}function Ke(e,t){const{component:n}=e;return ze(e,e.delivered,Ve(e.iRender,t,e.context,n[ne]),e.context.slots,Ee(n[re]),Boolean(e.native))}let Le;function Be(e){Le=e}function Fe(e){Le?Le.push(e):e()}class Ue{constructor(e,t,r=(null==t?void 0:t.delivered)||Object.create(null),o){n(this,"events",new x),n(this,"emit",this.events.emit),n(this,"on",this.events.on),n(this,"eventCancelHandles",new Set),n(this,"iRender",void 0),n(this,"components",Object.create(null)),n(this,"config",Object.create(null)),n(this,"parentDelivered",void 0),n(this,"delivered",void 0),n(this,"exposed",function(e){const t={$parent:{configurable:!0,get:()=>{var t;return null===(t=e.parent)||void 0===t?void 0:t.exposed}},$component:{configurable:!0,value:null},$isContainer:{configurable:!0,value:!1},$created:{configurable:!0,get:()=>e.created},$destroyed:{configurable:!0,get:()=>e.destroyed},$mounted:{configurable:!0,get:()=>e.mounted},$unmounted:{configurable:!0,get:()=>e.unmounted}};return Object.create(null,t)}(this)),n(this,"entity",function(e){const t={exposed:{configurable:!0,get:()=>e.exposed},delivered:{configurable:!0,get:()=>e.delivered},parent:{configurable:!0,get:()=>{var t;return null===(t=e.parent)||void 0===t?void 0:t.entity}},component:{configurable:!0,value:null},isContainer:{configurable:!0,value:!1},created:{configurable:!0,get:()=>e.created},destroyed:{configurable:!0,get:()=>e.destroyed},mounted:{configurable:!0,get:()=>e.mounted},unmounted:{configurable:!0,get:()=>e.unmounted},$_hooks:{configurable:!0,value:Object.create(null)},$_valueIndex:{configurable:!0,value:0,writable:!0},$_values:{configurable:!0,value:[]},$_serviceIndex:{configurable:!0,value:0,writable:!0},$_services:{configurable:!0,value:[]},callHook:{configurable:!0,value(e){F(e,n)}},setHook:{configurable:!0,value:(e,t)=>B(e,t,n)},refresh:{configurable:!0,value:e.refresh.bind(e)},on:{configurable:!0,value:e.on},emit:{configurable:!0,value:e.emit},config:{configurable:!0,value:e.config}},n=Object.create(null,t);return n}(this)),n(this,"parent",void 0),n(this,"native",void 0),n(this,"created",!1),n(this,"destroyed",!1),n(this,"mounted",!1),n(this,"unmounted",!1),n(this,"children",new Set),n(this,"tree",[]),n(this,"container",void 0),n(this,"_render",()=>[]),n(this,"_needRefresh",!1),n(this,"_delayedRefresh",0),n(this,"_refreshing",!1),n(this,"_nodes",[]),n(this,"childNodes",[]),n(this,"__executed_destroy",!1),n(this,"__executed_mount",!1),n(this,"__executed_mounted",!1),n(this,"_cancelDrawMonitor",void 0),this.iRender=e,this.parentDelivered=r,this.delivered=Object.create(r),t&&(this.parent=t),this.container=o||this}get canRefresh(){return!z(this)&&!this._delayedRefresh}get needRefresh(){if(z(this))return!1;if(this._delayedRefresh)return!1;const e=this._needRefresh;return this._needRefresh=!1,e}requestDraw(){}async asyncRefresh(e){try{return this._delayedRefresh++,await e()}finally{this._delayedRefresh--,this.refresh()}}refresh(e,t){if("function"==typeof e){if(t)return this.asyncRefresh(e);try{return this._delayedRefresh++,e()}finally{this._delayedRefresh--,this._delayedRefresh<=0&&this.refresh()}}if(this.destroyed)return;if(this._needRefresh=!0,!this.created)return;if(this._refreshing)return;let n;for(this._refreshing=!0;this.needRefresh;)if(n=this._render(),this.destroyed)return;this._refreshing=!1,this.canRefresh&&n&&(this._nodes=nt(this,n,this._nodes),this.mounted&&(this.destroyed||this.unmounted||this.requestDraw()))}callHook(e){F(e,this.entity)}_update(e,t){this.childNodes=t}update(e,t){this._update(e,t)}_destroy(){}destroy(){this.__executed_destroy||(this.__executed_destroy=!0,this.callHook("beforeDestroy"),this._destroy(),this.callHook("destroyed"),this.destroyed=!0)}_mount(){}mount(){if(this.__executed_destroy)return;if(this.__executed_mount)return;this.__executed_mount=!0,this.callHook("beforeMount");const e=g(e=>e&&this.requestDraw(),()=>{this._mount(),this.mounted=!0});this._cancelDrawMonitor=e.stop,Fe(()=>this.callHook("mounted"))}_unmount(){}unmount(){this.mounted&&(this.__executed_mounted||(this.__executed_mounted=!0,this.callHook("beforeUnmount"),this._unmount(),this.callHook("unmounted"),this.unmounted=!0))}_draw(){}draw(){if(this.__executed_destroy)return;this._cancelDrawMonitor&&this._cancelDrawMonitor(),this.callHook("beforeDraw");const e=g(e=>e&&this.requestDraw(),()=>this._draw());this._cancelDrawMonitor=e.stop,Fe(()=>this.callHook("drawn"))}}function Ge(e,t,n){Pe(e.props,t,{},!1,!0),e.events.updateInProps(t);const r=Object.create(null),{native:o}=e,i=$e(e.iRender,n,r,Boolean(o));je(r,e.slots),o&&(e.nativeNodes=nt(e,i,e.nativeNodes),e.mounted&&e.requestDraw())}class Je extends Ue{constructor(e,t,r,o,i){var s,c;super(o.iRender,o,i,o.container),n(this,"component",void 0),n(this,"props",u(Object.create(null))),n(this,"slots",u(Object.create(null))),n(this,"_stopRender",void 0),n(this,"nativeNodes",void 0),n(this,"shadowTree",[]),n(this,"nativeTree",[]),n(this,"_shadow",void 0),n(this,"context",void 0),n(this,"parent",void 0),this.component=e,Object.assign(this.config,e[oe]),Object.assign(this.components,e[re]),Reflect.defineProperty(this.exposed,"$component",{value:e,enumerable:!0,configurable:!0}),[this.native,this._shadow]="native"===e[ee]&&(null===(s=(c=this.iRender).createComponent)||void 0===s?void 0:s.call(c))||[],this.parent=o,o.children.add(this.exposed);const d=T({slots:(a=this).slots,get created(){return a.created},get parent(){return a.parent.exposed},get delivered(){return a.parentDelivered},get children(){return a.children},get childNodes(){return a.childNodes},get emit(){return a.emit},refresh(e){a.refresh(e)}},a.exposed);var a;this.context=d,this.callHook("beforeCreate"),this.childNodes=r,K(()=>Ge(this,t,r));const{render:l,nodes:f,stopRender:h}=function(e){const{component:t,props:n,context:r,entity:o}=e;function i(t){t&&e.refresh()}const s=g(i,()=>H(()=>t(n,r),o),{resultOnly:!0});if("function"==typeof s){const t=_(i,()=>Ke(e,s()));return{nodes:t(),render:t,stopRender:()=>t.stop()}}const c=_(i,()=>Ke(e,H(()=>t(n,r),o)));return{nodes:g(i,()=>Ke(e,s),{resultOnly:!0}),render:c,stopRender:()=>c.stop()}}(this);this._render=l,this._stopRender=h,this._nodes=nt(this,f),this.callHook("created"),this.created=!0,this._needRefresh&&this.refresh()}_update(e,t){this.destroyed||(this.childNodes=t,K(()=>Ge(this,e,t)))}_destroy(){this._stopRender&&this._stopRender(),this.parent.children.delete(this.exposed),We(this._nodes)}requestDraw(){this.container.markDraw(this)}_draw(){const{nativeNodes:e,iRender:t,_shadow:n,native:r}=this;r&&e&&n?(this.shadowTree=Ne(t,this._nodes,this.shadowTree),this.nativeTree=Ne(t,e,this.nativeTree)):this.tree=Ne(t,this._nodes,this.tree)}_mount(){const{nativeNodes:e,iRender:t,_shadow:n,native:r,_nodes:o}=this;if(r&&e&&n){this.tree=Ne(t,nt(this,r)),this.shadowTree=Ne(t,o);for(const e of ye(this.shadowTree))t.insertNode(n,e);this.nativeTree=Ne(t,e);for(const e of ye(this.nativeTree))t.insertNode(r,e)}else this.tree=Ne(t,o)}_unmount(){const{iRender:e,nativeTree:t}=this;ve(e,this.tree),t&&ve(e,t)}}function Qe(e){return!1===e||null==e?null:ie(e)?e:{[Z]:!0,tag:"Neep:Value",key:e,value:e,children:[]}}function We(e){if(Array.isArray(e))return void e.forEach(e=>We(e));const{component:t}=e;t&&t.destroy()}function Xe(e,t,n){if(!n)return{tag:null,key:void 0,children:[]};const{tag:r}=n;if(!r)return{tag:null,key:void 0,children:[]};if("string"!=typeof r)return"simple"===r[ee]?{...n,children:et(e,t,n.children),component:void 0}:{...n,children:[],component:new Je(r,n.props||{},n.children,e,t)};const o=r.toLowerCase();if("neep:container"===o){var i;const r=null==n?void 0:null===(i=n.props)||void 0===i?void 0:i.type,o=r?c(r):e.iRender;return{...n,children:[],component:new it(o,n.props||{},n.children,e,t)}}if("neep:value"===o)return{...n,children:[]};if("neep:deliver"===o){const r={...n.props};delete r.ref,delete r.slot,delete r.key;const o=Pe(Object.create(t),r,{},!0);return{...n,delivered:o,children:et(e,o,n.children)}}return o.substr(0,5),{...n,children:et(e,t,n.children)}}function Ye(e,t,n,r){Array.isArray(r)||(r=[r]);const o=[];for(const i of ue(n)){const n=Qe(i);if(!n)continue;const s=r.findIndex(e=>e.tag===n.tag&&e.key===n.key);s>=0?(o.push(Ze(e,t,n,r[s])),r.splice(s,1)):o.push(Xe(e,t,n))}return We(r),o}function Ze(e,t,n,r){if(!r)return Xe(e,t,n);if(!n)return We(r),{tag:null,key:void 0,children:[]};if(Array.isArray(r)){if(!r.length)return Xe(e,t,n);const o=r.findIndex(e=>e.tag===n.tag);if(o<0)return We(r),Xe(e,t,n);const i=r;[r]=r.splice(o,1),We(i)}const{tag:o}=n;if(o!==r.tag)return We(r),Xe(e,t,n);if(!o)return{tag:null,key:void 0,children:[]};if("string"!=typeof o){if("simple"===o[ee])return{...n,children:[...tt(e,t,n.children,r.children)],component:void 0};const{component:i}=r;return i?(i.update(n.props||{},n.children),{...n,children:[],component:i}):Xe(e,t,n)}const i=o.toLowerCase();if("neep:container"===i){var s;const{component:o}=r;if(!o)return Xe(e,t,n);const i=null==n?void 0:null===(s=n.props)||void 0===s?void 0:s.type;return(i?c(i):e.iRender)!==o.iRender?Xe(e,t,n):(o.update(n.props||{},n.children),{...n,children:[],component:o})}if("neep:value"===i)return{...n,children:[]};if("neep:deliver"===i){const o={...n.props};delete o.ref,delete o.slot,delete o.key;const i=Pe(r.delivered||Object.create(t),o,r.props,!0);return{...n,delivered:i,children:[...tt(e,t,n.children,r.children)]}}return i.substr(0,5),{...n,children:[...tt(e,t,n.children,r.children)]}}function et(e,t,n){return Array.isArray(n)||(n=[n]),n.length?n.map(n=>Array.isArray(n)?[...ue(n)].map(n=>Xe(e,t,Qe(n))):Xe(e,t,Qe(n))):[]}function*tt(e,t,n,r){Array.isArray(n)||(n=[n]);let o=0,i=Math.min(n.length,n.length);for(;o<i;o++){const i=n[o];Array.isArray(i)?yield Ye(e,t,i,r[o]):yield Ze(e,t,Qe(i),r[o])}if(i=Math.max(n.length,n.length),r.length>i)for(;o<i;o++)We(r[o]);if(n.length>i)for(;o<i;o++){const r=Qe(n[o]);Array.isArray(r)?yield[...ue(r)].map(n=>Xe(e,t,n)):yield Xe(e,t,r)}}function nt(e,t,n){return n?[...tt(e,e.delivered,t,n)]:et(e,e.delivered,t)}let rt=new Set,ot=!1;class it extends Ue{constructor(e,t,r,o,i){super(e,o,i),n(this,"props",void 0),n(this,"content",[]),n(this,"_node",null),n(this,"_container",null),n(this,"rootContainer",this),n(this,"_drawChildren",!1),n(this,"_drawContainer",!1),n(this,"_awaitDraw",new Set),n(this,"_needDraw",!1),n(this,"_containers",new Set),this.props=t,this.parent=o,o&&(this.rootContainer=o.container.rootContainer),this.callHook("beforeCreate"),this._render=()=>r,this._nodes=nt(this,r),this.callHook("created"),this.created=!0}setChildren(e){this.destroyed||(this.childNodes=e,this._render=()=>e,this._drawChildren=!0,this.refresh())}setProps(e){this.destroyed||(this.props=e,this._drawContainer=!0,this.refresh())}update(e,t){this.refresh(()=>{this.setProps(e),this.setChildren(t)})}requestDraw(){this.markDraw(this)}_mount(){const{props:e,parent:t,iRender:n}=this,r=Ne(this.container.iRender,this._nodes);this.content=r;const[o,i]=n.mount(e,null==t?void 0:t.iRender);for(const e of ye(r))n.insertNode(o,e);this.tree=[le({tag:N,key:void 0,component:void 0,node:i,value:i,children:[]})],this._node=i,this._container=o}_destroy(){We(this.content)}_unmount(){const{parent:e,iRender:t}=this;e&&ve(e.iRender,this.tree),t.unmount(this._container,this._node,Boolean(e)),ve(this.iRender,this.content)}_draw(){const{_drawChildren:e,_drawContainer:t}=this;var n;(this._drawContainer=!1,t)&&this.iRender.drawContainer(this._container,this._node,this.props,null===(n=this.parent)||void 0===n?void 0:n.iRender);this.parent&&this.parent.iRender!==this.iRender||(this._drawChildren=!1,e&&(this.content=Ne(this.iRender,this._nodes,this.content)))}_drawSelf(){const{_drawChildren:e,_drawContainer:t}=this;var n;(this._needDraw=!1,this._drawChildren=!1,this._drawContainer=!1,t)&&this.iRender.drawContainer(this._container,this._node,this.props,null===(n=this.parent)||void 0===n?void 0:n.iRender,!0);e&&(this.content=Ne(this.iRender,this._nodes,this.content))}drawSelf(){this.mounted&&(this.destroyed||(this.callHook("beforeDraw"),g(e=>e&&this.markDraw(this),()=>this._drawSelf()),Fe(()=>this.callHook("drawn"))))}markDraw(e,t=!1){var n;(null===(n=this.parent)||void 0===n?void 0:n.iRender)!==this.iRender?(e===this&&this.parent?(this.parent.container.markDraw(this,t),this._needDraw=!t):t?this._awaitDraw.delete(e):this._awaitDraw.add(e),this.rootContainer.markDrawContainer(this,!this._needDraw&&!this._awaitDraw.size||this.destroyed)):this.parent.container.markDraw(e,t)}drawContainer(){const{_node:e,_container:t,_awaitDraw:n}=this;if(!e||!t)return;this.callHook("beforeDraw");const r=this._needDraw;this._needDraw=!1;const o=[...n];n.clear(),r&&this.drawSelf(),o.map(e=>e.draw()),this.iRender.drawNode(t,e),Fe(()=>this.callHook("drawn"))}markDrawContainer(e,t=!1){var n;t?this._containers.delete(e):this._containers.add(e),n=this,rt.add(n),ot||(ot=!0,i(()=>{ot=!1;const e=[...rt];rt.clear(),e.map(e=>e.drawAll())}))}drawAll(){const e=this._containers;if(!e.size)return;this.callHook("beforeDrawAll");const t=[],n=[];Be(n),he(t);const r=[...e];e.clear(),r.forEach(e=>e.drawContainer()),he(),t.forEach(e=>e()),n.forEach(e=>e()),this.callHook("drawnAll")}}function st(e,t={}){let n={...t};const r=new it(c(t.type),n,void 0===e?[]:ie(e)?[e]:[se(e)]),{exposed:o}=r;return Reflect.defineProperty(o,"$update",{value:e=>(r.setChildren(void 0===e?[]:ie(e)?[e]:[se(e)]),o),configurable:!0}),Reflect.defineProperty(o,"$mount",{value:e=>o.$mounted?o:(e&&(n.target=e,r.setProps(n)),r.mount(),o),configurable:!0}),Reflect.defineProperty(o,"$unmount",{value(){if(o.$mounted&&!o.$unmounted)return o.$destroyed?r.destroy():void r.unmount()},configurable:!0}),n.target&&r.mount(),o}function ct(e,t){return n=>(n[e]=t,n)}function dt(e,t,n){return r=>{let o=r[e];return o||(o=Object.create(null),r[e]=o),o[t]=n,r}}function at(e,t){return t?(t[te]=e,t):ct(te,e)}function lt(e,t){return t?(t[ee]=e,t):ct(ee,e)}function ut(e){return e?(e[ee]="simple",e):ct(ee,"simple")}function ft(e){return e?(e[ee]="native",e):ct(ee,"native")}function ht(e,t){return t?(t[ne]=e,t):ct(ne,e)}function pt(e,t,n){const r=dt(oe,e,t);return n?r(n):r}function yt(e,t,n){const r=dt(re,e,t);return n?r(n):r}function vt(e,t){return"function"==typeof t&&(e[ne]=t),e}function mt(e,...t){for(const n of t)n(e);return e}function gt(e,t){const n=d(0),r=d(void 0);return mt((function(o,{childNodes:i}){const s=r();return s?se(s,o,...i):(async function(){if(!n()){n(1);try{const t=await e();if("function"==typeof t)return void r(t);if(!t)return void n(-1);if("function"==typeof t.default)return void r(t.default);n(-1)}catch(e){n(-1)}}}(),t?se(t,{loading:n()>0}):null)}),ut,at("Lazy"))}export{$ as Container,C as Deliver,r as Error,x as EventEmitter,j as Fragment,k as ScopeSlot,D as Slot,A as SlotRender,S as Template,N as Value,E as addContextConstructor,m as asValue,F as callHook,P as checkCurrent,re as componentsSymbol,a as computed,oe as configSymbol,vt as create,se as createElement,O as current,Y as deliver,ce as elements,u as encase,X as expose,ae as getRect,Q as hook,w as install,ie as isElement,Z as isElementSymbol,t as isProduction,l as isValue,de as label,gt as lazy,yt as mComponent,pt as mConfig,at as mName,ft as mNative,ht as mRender,ut as mSimple,lt as mType,mt as mark,te as nameSymbol,f as recover,K as refresh,Te as register,st as render,ne as renderSymbol,B as setHook,ee as typeSymbol,J as useService,G as useValue,d as value,h as valueify,e as version,U as watch};
