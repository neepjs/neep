/*!
 * Neep v0.1.0-alpha.15
 * (c) 2019-2020 Fierflame
 * @license MIT
 */
import{postpone as e}from"monitorable";const t="0.1.0-alpha.15",n=!0;function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class o extends Error{constructor(e,t=""){super(t?`[${t}] ${e}`:e),r(this,"tag",void 0),this.tag=t}}function i(e,t,n){if(!e)throw new o(t,n)}let s;const c=Object.create(null);function l(e=""){return"object"==typeof e?e:c[e]||c.default}let u,a,d,f,h,p,y,v,m,g,_,b,w,$,R;function x(e){var t;(t=e.monitorable)&&({value:u,computed:a,isValue:d,encase:f,recover:h,valueify:p,markRead:y,markChange:v,safeify:m,asValue:g,exec:_,monitor:b,printError:w,postpone:$}=t),function(e){e&&(c[e.type]=e,s||(c.default||(c.default=e),!s&&e.nextFrame&&(c.default=e,s=e.nextFrame)))}(e.render)}function A(e,t){const n=R;R=t;try{R.$_valueIndex=0,R.$_serviceIndex=0;const t=e();if(R.$_valueIndex!==R.$_values.length)throw new o("Inconsistent number of useValue executions","life");if(R.$_serviceIndex&&R.$_serviceIndex!==R.$_services.length)throw new o("Inconsistent number of useService executions","life");return t}finally{R=n}}function k(e,t=!1){if(!R)throw new o(`Function \`${e}\` can only be called within a cycle.`,"life");if(!t)return R;if(!R.created)return R;throw new o(`Function \`${e}\` can only be called at initialization time.`,"life")}const j=[];function D(e,t){for(const n of j)n(e,t);return e}function S(e){j.push(m(e))}const C=[];function O(e){C.push(m(e))}let N=0;const P=new Set;function T(e){return!(N<=0)&&(P.add(e),!0)}function H(){if(N>0)return;const e=[...P];P.clear(),e.forEach(e=>e.refresh())}function E(e,t){if(t)return async function(e){try{return N++,await e()}finally{N--,H()}}(e);try{return N++,e()}finally{N--,H()}}function I(e){return"@"===e[0]?e.substr(1):/^on[:-]/.test(e)?e.substr(3):/^n([:-])on(\1|:)/.test(e)?e.substr(5):""}function M(e,t){if(t)if("function"!=typeof t){if("object"==typeof t)for(const n of Object.keys(t)){const r=t[n];"function"==typeof r&&e(n,r)}}else{const{names:n}=t;if(!Array.isArray(n))return;for(const r of n)r&&e(r,(...e)=>t(r,...e))}}class q{static update(e,t){if(!t)return[];const n=[];if(t&&"object"==typeof t)for(const r of Object.keys(t)){if(!r)continue;const o=t[r];"function"==typeof o&&n.push(e.on(r,o))}return n}static updateInProps(e,t,n){if(!t)return[];const r=[];function o(t,n){r.push(e.on(t,n))}for(const e of Object.keys(t)){const n=t[e];if("function"!=typeof n)continue;const r=I(e);r&&o(r,n)}return M(o,t["@"]),M(o,t["n:on"]),M(o,t["n-on"]),"function"==typeof n&&n(o),r.push(...q.update(e,t["@"])),r}get names(){return[...this._names]}constructor(){r(this,"_names",new Set),r(this,"_cancelHandles",new Set),r(this,"emit",void 0),r(this,"on",void 0);const e=Object.create(null),t=this._names;function n(...r){function o(t,...n){const r=e[t];return!r||E(()=>{let e=!0;for(const t of[...r])e=t(...n)&&e;return e})}return o.omit=(...e)=>n(...r,...e),Reflect.defineProperty(o,"names",{get:()=>(y(n,"names"),[...t].filter(e=>!r.includes(e))),configurable:!0}),o}this.emit=n(),this.on=(r,o)=>{var i;function s(...e){try{return!1!==o(...e)}catch(e){return w(e),!0}}let c=e[r];(null===(i=c)||void 0===i?void 0:i.size)||(c=new Set,e[r]=c,v(n,"names"),t.add(r)),c.add(s);let l=!1;return()=>{l||(l=!0,c.delete(s),c.size||(v(n,"names"),t.delete(r)))}}}updateHandles(e){const t=this._cancelHandles,n=[...t];t.clear();for(const e of n)e();return e.forEach(e=>t.add(e)),e}update(e){const t=q.update(this,e);return this.updateHandles(t)}updateInProps(e,t){const n=q.updateInProps(this,e,t);return this.updateHandles(n)}}const K="neep:ScopeSlot",z="neep:SlotRender",V="neep:slot",F="neep:value",L="neep:container",B="template",U=B;function W(e){if(e&&("function"==typeof e||"object"==typeof e))return function(t,n){n?e.delete(t):e.add(t)};if(e){const e=u(null);function t(t,n){e.value=n?null:t}return Reflect.defineProperty(t,"value",{get:()=>e.value,enumerable:!0,configurable:!0}),t}let n=null;function t(e,t){n=t?null:e}return Reflect.defineProperty(t,"value",{get:()=>n,enumerable:!0,configurable:!0}),t}const G=Object.create(null);function J(e,t,n){let r=(null==n?void 0:n.$_hooks)||G;if(!r)return()=>{};t=m(t);let o=r[e];return o||(o=new Set,r[e]=o),o.add(t),()=>o.delete(t)}function Q(e,t){if(t){for(const n of t.$_hooks[e]||[])n(t);for(const n of G[e]||[])n(t)}}function X(e,t){const n=k("watch");if("function"!=typeof e)return()=>{};const r=d(e)?e.watch(t):a(e).watch((e,n)=>t(e(),n));return J("beforeDestroy",()=>r(),n),r}function Y(e){const t=k("useValue"),n=t.$_valueIndex++,r=t.$_values;if(!t.created){r[n]=void 0;const t="function"==typeof e?e():u(void 0);return r[n]=t}if(n>=r.length)throw new o("Inconsistent number of useValue executions","life");return r[n]}function Z(e,...t){const n=k("useService"),r=n.$_serviceIndex++,i=n.$_services;if(!n.created){i[r]=void 0;const o=e(n,...t);return i[r]=o,o}if(r>=i.length)throw new o("Inconsistent number of useService executions","life");return i[r]}function ee(e,...t){return e(k("byService"),...t)}function te(e,t,n){const r=k("setHook");if(!n||!r.created)return J(e,()=>t(),r)}function ne(e,t,n){!function(e,t,n,r){"string"==typeof t&&["$","_"].includes(t[0])||(d(n)&&r?Reflect.defineProperty(e,t,{get:()=>n(),set(e){n(e)},configurable:!0,enumerable:!0}):"function"==typeof n&&r?Reflect.defineProperty(e,t,{get:n,set:"function"==typeof r?r:void 0,configurable:!0,enumerable:!0}):Reflect.defineProperty(e,t,{get:()=>n,configurable:!0,enumerable:!0}))}(k("expose",!0).exposed,e,t,n)}const re=Symbol.for("type"),oe=Symbol.for("name"),ie=Symbol.for("render"),se=Symbol.for("components"),ce=Symbol.for("config"),le=Symbol.for("$$$objectType$$$"),ue="$$$objectType$$$Element",ae="$$$objectType$$$Deliver",de=Symbol.for("$$$deliverKey$$$"),fe=Symbol.for("$$$deliverDefault$$$");function he(e){return!!e&&("object"==typeof e&&"$$$objectType$$$Element"===e[le])}function pe(e){return!!e&&("function"==typeof e&&"simple"===e[re])}function ye(e){return he(e)&&pe(e.tag)}function ve(e,t,...n){const r=t?{...t}:{},o={[le]:"$$$objectType$$$Element",tag:e,key:void 0,props:r,children:n};return"n:key"in r?o.key=r["n:key"]:"n-key"in r?o.key=r["n-key"]:"key"in r&&(o.key=r.key),"n:slot"in r?o.slot=r["n:slot"]:"n-slot"in r?o.slot=r["n-slot"]:"slot"in r&&(o.slot=r.slot),"function"==typeof r["n:ref"]?o.ref=r["n:ref"]:"function"==typeof r["n-ref"]?o.ref=r["n-ref"]:"function"==typeof r.ref&&(o.ref=r.ref),e===F&&(o.value=r.value),o}function me(e,t={}){if(Array.isArray(e)){const n=[];for(let r of e)n.push(me(r,t));return[].concat(...n)}if(!he(e))return[e];let{tag:n}=e;if(!n)return[e];if([B,K].includes(n))return me(e.children,t);if("function"!=typeof n)return[e];if("simple"!==n[re])return[e];const{simple:r=!0}=t;if(!r)return[e];if(Array.isArray(r)){if(r.includes(n))return[e]}else if("function"==typeof r&&!r(n))return[e];return me(e.children,t)}function ge(e,t){if(Object.is(e,t))return!0;if(!e)return!1;if(!t)return!1;if("object"!=typeof e)return!1;if("object"!=typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(let n=e.length-1;n>=0;n--)if(!ge(e[n],t[n]))return!1;return!0}return!Array.isArray(t)&&(!!he(e)&&(!!he(t)&&(e.tag===t.tag&&(e.execed===t.execed&&(e.inserted===t.inserted&&(e.ref===t.ref&&(e.value===t.value&&(e.key===t.key&&(e.slot===t.slot&&(function(e,t){if(Object.is(e,t))return!0;if(!e)return!1;if(!t)return!1;if("object"!=typeof e)return!1;if("object"!=typeof t)return!1;const n=new Set(Reflect.ownKeys(e)),r=Reflect.ownKeys(t);if(n.size!==r.length)return!1;for(const o of r){if(!n.has(o))return!1;if(e[o]!==t[o])return!1}return!0}(e.props,t.props)&&ge(e.children,t.children)))))))))))}function _e(e,t=""){}function be(e){for(const t of[...Object.values(c)]){if(!t)continue;if(!t.isNode(e))continue;const n=t.getRect(e);if(n)return n}return null}function we(e){const t=Symbol();function n(e,{childNodes:t}){return t}return Reflect.defineProperty(n,le,{value:"$$$objectType$$$Deliver"}),Reflect.defineProperty(n,de,{value:t}),Reflect.defineProperty(n,fe,{value:e}),n}function $e(e){return"function"==typeof e&&"$$$objectType$$$Deliver"===e[le]}function Re(e,t){i($e(t),"");const n=e[t[de]];return void 0===n?t[fe]:n}function xe(e,t){return{...e,id:0}}function*Ae(e){if(Array.isArray(e))for(const t of e)yield*Ae(t);else yield e}let ke;function je(e){ke=e}function De(e,t,n){"function"==typeof e&&t&&(ke?ke.push(()=>e(t,n)):e(t,n))}function*Se(e){if(Array.isArray(e)){for(const t of e)yield*Se(t);return}const{children:t,node:n,component:r}=e;n?yield n:r?yield*Se(r.tree):yield*Se(t)}function Ce(e,t){if(Array.isArray(t))return void t.forEach(t=>Ce(e,t));const{component:n,children:r,node:o,ref:i}=t;if(n)return De(i,n.exposed,!0),void n.unmount();o&&(De(i,o,!0),e.removeNode(o)),Ce(e,r)}function Oe(e,t,n){let{ref:r}=t;if(e.isNode(n))return De(r,n),xe({...t,value:n,node:n,children:[],component:void 0});const o=typeof n;let i;return"bigint"===o||"boolean"===o||"number"===o||"string"===o||"symbol"===o||n instanceof RegExp?i=e.createText(String(n)):n instanceof Date?i=e.createText(n.toISOString()):"object"===o&&n&&(i=e.createText(String(n))),i||(i=e.createPlaceholder()),De(r,i),xe({...t,value:n,node:i,component:void 0,children:[]})}function Ne(e,t){return t.length?t.map(t=>Array.isArray(t)?Pe(e,t):Te(e,t)):[xe({tag:null,node:e.createPlaceholder(),component:void 0,children:[]})]}function Pe(e,t){return t.length?t.map(t=>Te(e,t)):[xe({tag:null,node:e.createPlaceholder(),component:void 0,children:[]})]}function Te(e,t){var n;const{tag:r,ref:o,component:i}=t;if(!r){const t=e.createPlaceholder();return De(o,t),xe({tag:null,node:t,component:void 0,children:[]})}if($e(r))return xe({...t,node:void 0,component:void 0,children:Ne(e,t.children)});const s="string"!=typeof r?"":r.toLowerCase();if("string"!=typeof r||s===L)return i?(i.mount(),De(o,i.exposed),xe({...t,node:void 0,component:i,children:[]})):xe({...t,node:void 0,component:void 0,children:Ne(e,t.children)});if(s===F){let{value:n}=t;return d(n)&&(n=n()),Oe(e,t,n)}if("neep:"===s.substr(0,5)||"template"===s)return xe({...t,node:void 0,component:void 0,children:Ne(e,t.children)});const c=e.createElement(r);De(o,c);let l=[];if(null===(n=t.children)||void 0===n?void 0:n.length){l=Ne(e,t.children);for(const t of Se(l))e.insertNode(c,t)}return e.updateProps(c,t.props||{}),xe({...t,node:c,component:void 0,children:l})}function He(e){if(Array.isArray(e))return He(e[e.length-1]);const{component:t,children:n,node:r}=e;return r||He(t?t.tree:n)}function Ee(e){if(Array.isArray(e))return Ee(e[0]);const{component:t,children:n,node:r}=e;return r||Ee(t?t.tree:n[0])}function Ie(e,t,n){const r=Ee(n);if(!r)return t;const o=e.getParent(r);if(!o)return t;for(const n of Se(t))e.insertNode(o,n,r);return Ce(e,n),t}function Me(e,t,n){if(!t.length){return[Ie(e,Te(e,{tag:null,children:[]}),n)]}Array.isArray(n)||(n=[n]);const r=[],o=[...n],i=new Map;for(const n of t){const t=o.findIndex(e=>e.tag===n.tag&&e.key===n.key);if(t>=0){const s=o[t],c=Ke(e,n,s);i.set(s,c),r.push(c),o.splice(t,1)}else{const t=Te(e,n);r.push(t)}}if(!i.size)return Ie(e,r,o);Ce(e,o);const s=He((n=n.filter(e=>i.has(e)))[n.length-1]),c=e.getParent(s);if(!c)return r;let l=e.nextNode(s);for(let t=r.length-1;t>=0;t--){const o=r[t],s=n.findIndex(e=>i.get(e)===o);if(s>=0)for(const e of n.splice(s))i.delete(e);else for(const t of Se(o))e.insertNode(c,t,l);l=Ee(o)||l}return r}function qe(e,t,n){let r=0,o=Math.min(t.length,n.length);const i=[];for(;r<o;r++){const o=t[r];Array.isArray(o)?i.push(Me(e,o,n[r])):i.push(Ke(e,o,n[r]))}if(o=Math.max(t.length,n.length),n.length>r)for(;r<o;r++)Ce(e,n[r]);if(t.length>r){const n=He(i[i.length-1]),s=e.getParent(n),c=e.nextNode(n);for(;r<o;r++){const n=t[r],o=Array.isArray(n)?Pe(e,n):Te(e,n);if(i.push(o),s)for(const t of Se(o))e.insertNode(s,t,c)}}return i}function Ke(e,t,n){if(Array.isArray(n)){const r=n.findIndex(e=>e.tag===t.tag&&e.component===t.component);if(r<0)return Ie(e,Te(e,t),n);const o=n;[n]=n.splice(r,1),Ce(e,o)}const{tag:r,component:o}=t,i=t.ref!==n.ref&&t.ref||void 0;if(r!==n.tag||o!==n.component)return Ie(e,Te(e,t),n);if($e(r))return xe({...t,node:void 0,component:void 0,children:qe(e,t.children,n.children)},n.id);if(!r)return n;const s="string"!=typeof r?"":r.toLowerCase();if("string"!=typeof r||s===L)return o?(De(i,o.exposed),xe({...t,node:void 0,component:o,children:[]},n.id)):xe({...t,node:void 0,component:void 0,children:qe(e,t.children,n.children)},n.id);if(s===F){let{value:r}=t;return d(r)&&(r=r()),n.value===r?(De(i,n.node),xe({...n,...t,value:r,children:[]},n.id)):Ie(e,Oe(e,t,r),n)}if("neep:"===s.substr(0,5)||"template"===s)return xe({...t,node:void 0,component:void 0,children:qe(e,t.children,n.children)},n.id);const{node:c}=n;De(i,c);let l=[];if(!t.children.length&&n.children.length)Ce(e,n.children);else if(t.children.length&&n.children.length)l=qe(e,t.children,n.children);else if(t.children.length&&!n.children.length){l=Ne(e,t.children);for(const t of Se(l))e.insertNode(c,t)}return e.updateProps(c,t.props||{}),xe({...n,...t,children:l},n.id)}function ze(e,t,n){return n?qe(e,t,n):Ne(e,t)}function Ve(e,t,n,r=!1){const o=[];for(const i of t){if(Array.isArray(i)){const t=Object.create(null);o.push(Ve(e,i,t,r));for(const e of Reflect.ownKeys(t))e in n?n[e].push(t[e]):n[e]=[t[e]];continue}if(he(i)&&void 0===i.slot&&("function"==typeof i.tag&&"simple"===i.tag[re]&&i.execed||i.tag===B)){const t=Object.create(null);o.push(Ve(e,i.children,t,r));for(const e of Reflect.ownKeys(t)){const r={...i,children:t[e]};e in n?n[e].push(r):n[e]=[r]}continue}if(r){if(e.isNode(i)){o.push(i);continue}if(!he(i)){o.push(i);continue}if(i.tag!==z&&i.tag!==B){o.push(i);continue}}const t=he(i)&&i.slot||"default",s=he(i)?{...i,slot:void 0,props:{...i.props,slot:void 0}}:i;t in n?n[t].push(s):n[t]=[s]}return o}function Fe(e,...t){return e.map(e=>{if(Array.isArray(e))return Fe(e,...t);if(!he(e))return e;if(e.tag!==z)return{...e,slot:void 0};const{children:n}=e;if(1!==(null==n?void 0:n.length))return n;const[r]=n;return d(r)||"function"!=typeof r?n:r(...t)})}function Le(e,t){const n=(...e)=>({[le]:"$$$objectType$$$Element",tag:K,children:Fe(t,...e),inserted:!0,label:void 0});return n.children=t,n}function Be(e,t=Object.create(null),n){for(const n of Reflect.ownKeys(t))n in e||delete t[n];if(!n){for(const n of Reflect.ownKeys(e))t[n]=Le(0,e[n]);return t}for(const r of Reflect.ownKeys(e)){const o=e[r];ge(o,n[r])||(t[r]=Le(0,o))}return t}const Ue=Object.create(null);function We(e,t){Ue[e]=t}function Ge(e,t){if(!e)return null;if("string"!=typeof e)return e;if("template"===e)return e;if(/^neep:.+/i.test(e))return e;for(const n of t){const t=n[e];if(t)return t}return Ue[e]||e}function Je(e,t){if(1!==e.length)return e;const[n]=e;return"function"!=typeof n?e:n(...t)}function Qe(...e){return e.filter(Boolean)}function Xe(e,t,n,r,o,i){if(Array.isArray(n))return n.map(n=>Xe(e,t,n,r,o,i));if(!he(n))return n;let{tag:s,children:c}=n;if($e(s)){const l=Object.create(t);return Reflect.defineProperty(l,s[de],{configurable:!0,enumerable:!0,value:n.props?n.props.value:void 0}),{...n,tag:s,children:c.map(t=>Xe(e,l,t,r,o,i))}}if(s===z){const s=function(e,t,n,r,o,i){if(1!==n.length)return null;const[s]=n;if(d(s)||"function"!=typeof s)return null;const{slotRenderFnList:c}=e,l=c.get(s);if(l)return l;const u=function(...n){return et(e,t,s.call(this,...n),r,o,i)};return c.set(s,u),u}(e,t,c,r,o,i);if(s)return{...n,children:[s]}}return"function"!=typeof s||"simple"!==s[re]?{...n,tag:s,children:c.map(n=>Xe(e,t,n,r,o,i))}:function(e,t,n,r,o,i){if(n.execed)return n;const{iRender:s}=e,c=Object.create(null);Ve(s,i,c);const l=Be(c),u=new q;u.updateInProps(n.props);const a={...n.props},d=D({slots:l,created:!1,parent:e.exposed,delivered:e=>Re(t,e),children:new Set,childNodes:i,refresh(t){e.refresh(t)},emit:u.emit}),f=r(a,d),h=et(e,t,Ze(e.iRender,f,d,r[ie]),l,Qe(...o,r[se]),!1);return{...n,tag:r,execed:!0,children:Array.isArray(h)?h:[h],label:void 0}}(e,t,n,s,o,c)}function Ye(e){return Array.isArray(e)?e.map(Ye):he(e)?e:null==e?{[le]:"$$$objectType$$$Element",tag:null,key:void 0,children:[]}:{[le]:"$$$objectType$$$Element",key:void 0,tag:F,value:e,children:[]}}function Ze(e,t,n,r){if(Array.isArray(t))return t;if(he(t))return t.tag===U?t.children.map(Ye):[t];if(!t||!r||e.isNode(t))return[t];if("object"!=typeof t)return[t];const o=r(t,n);return Array.isArray(o)?o:[o]}function et(e,t,n,r,o,i){return E(()=>$(()=>Xe(e,t,function e(t,n,r,o,i){var s;if(Array.isArray(t))return t.map(t=>e(t,n,r,o,i));if(!he(t))return t;let{children:c,props:l}=t,u=Ge(t.tag,r);if(u===z&&i)return null;if(u===V&&(u=o?"slot":K),u!==K)return{...t,tag:u,children:e(c,n,r,o,i)};if(t.tag===K&&t.inserted)return t;const a=(null==l?void 0:l.argv)&&[l.argv]||Array.isArray(null==l?void 0:l.args)&&(null==l?void 0:l.args.length)&&l.args||[{}],d=(null===(s=t.props)||void 0===s?void 0:s.name)||"default",f=n[d];return"function"==typeof f?{...t,...f(...a)}:{...t,tag:K,label:void 0,children:e(Je(c,a),n,r,o,!1)}}(n,r,o,i,!0).map(Ye),r,o,i)))}function tt(e,t){const{component:n}=e;return et(e,e.delivered,Ze(e.iRender,t,e.context,n[ie]),e.slots,Qe(n[se]),Boolean(e.native))}let nt;function rt(e){nt=e}function ot(e){nt?nt.push(e):e()}function it(e){const t={exposed:{configurable:!0,get:()=>e.exposed},parent:{configurable:!0,get:()=>{var t;return null===(t=e.parent)||void 0===t?void 0:t.entity}},component:{configurable:!0,value:null},isContainer:{configurable:!0,value:!1},created:{configurable:!0,get:()=>e.created},destroyed:{configurable:!0,get:()=>e.destroyed},mounted:{configurable:!0,get:()=>e.mounted},unmounted:{configurable:!0,get:()=>e.unmounted},$_hooks:{configurable:!0,value:Object.create(null)},$_valueIndex:{configurable:!0,value:0,writable:!0},$_values:{configurable:!0,value:[]},$_serviceIndex:{configurable:!0,value:0,writable:!0},$_services:{configurable:!0,value:[]},callHook:{configurable:!0,value(e){Q(e,n)}},setHook:{configurable:!0,value:(e,t)=>J(e,t,n)},refresh:{configurable:!0,value:e.refresh.bind(e)},on:{configurable:!0,value:e.on},emit:{configurable:!0,value:e.emit},config:{configurable:!0,value:e.config}},n=Object.create(null,t);return function(e){for(const t of C)t(e);return e}(n)}class st{constructor(e,t,n=(null==t?void 0:t.delivered)||Object.create(null),o){r(this,"slotRenderFnList",new WeakMap),r(this,"events",new q),r(this,"emit",this.events.emit),r(this,"on",this.events.on),r(this,"eventCancelHandles",new Set),r(this,"iRender",void 0),r(this,"components",Object.create(null)),r(this,"config",Object.create(null)),r(this,"parentDelivered",void 0),r(this,"delivered",void 0),r(this,"exposed",function(e){const t={$parent:{configurable:!0,get:()=>{var t;return null===(t=e.parent)||void 0===t?void 0:t.exposed}},$component:{configurable:!0,value:null},$isContainer:{configurable:!0,value:!1},$created:{configurable:!0,get:()=>e.created},$destroyed:{configurable:!0,get:()=>e.destroyed},$mounted:{configurable:!0,get:()=>e.mounted},$unmounted:{configurable:!0,get:()=>e.unmounted}};return Object.create(null,t)}(this)),r(this,"entity",it(this)),r(this,"parent",void 0),r(this,"native",void 0),r(this,"created",!1),r(this,"destroyed",!1),r(this,"mounted",!1),r(this,"unmounted",!1),r(this,"children",new Set),r(this,"tree",[]),r(this,"container",void 0),r(this,"_render",()=>[]),r(this,"_needRefresh",!1),r(this,"_delayedRefresh",0),r(this,"_refreshing",!1),r(this,"_nodes",[]),r(this,"childNodes",[]),r(this,"__executed_destroy",!1),r(this,"__executed_mount",!1),r(this,"__executed_mounted",!1),r(this,"_cancelDrawMonitor",void 0),this.iRender=e,this.parentDelivered=n,this.delivered=Object.create(n),t&&(this.parent=t),this.container=o||this}get canRefresh(){return!T(this)&&!this._delayedRefresh}get needRefresh(){if(T(this))return!1;if(this._delayedRefresh)return!1;const e=this._needRefresh;return this._needRefresh=!1,e}requestDraw(){}async asyncRefresh(e){try{return this._delayedRefresh++,await e()}finally{this._delayedRefresh--,this.refresh()}}refresh(e,t){if("function"==typeof e){if(t)return this.asyncRefresh(e);try{return this._delayedRefresh++,e()}finally{this._delayedRefresh--,this._delayedRefresh<=0&&this.refresh()}}if(this.destroyed)return;if(this._needRefresh=!0,!this.created)return;if(this._refreshing)return;let n;for(this._refreshing=!0;this.needRefresh;)if(n=this._render(),this.destroyed)return;this._refreshing=!1,this.canRefresh&&n&&(this._nodes=gt(this,n,this._nodes),this.mounted&&(this.destroyed||this.unmounted||this.requestDraw()))}callHook(e){Q(e,this.entity)}_update(e,t){this.childNodes=t}update(e,t){this._update(e,t)}_destroy(){}destroy(){this.__executed_destroy||(this.__executed_destroy=!0,this.callHook("beforeDestroy"),this._destroy(),this.callHook("destroyed"),this.destroyed=!0)}_mount(){}mount(){if(this.__executed_destroy)return;if(this.__executed_mount)return;this.__executed_mount=!0,this.callHook("beforeMount");const e=_(e=>e&&this.requestDraw(),()=>{this._mount(),this.mounted=!0});this._cancelDrawMonitor=e.stop,ot(()=>this.callHook("mounted"))}_unmount(){}unmount(){this.mounted&&(this.__executed_mounted||(this.__executed_mounted=!0,this.callHook("beforeUnmount"),this._unmount(),this.callHook("unmounted"),this.unmounted=!0))}_draw(){}draw(){if(this.__executed_destroy)return;this._cancelDrawMonitor&&this._cancelDrawMonitor(),this.callHook("beforeDraw");const e=_(e=>e&&this.requestDraw(),()=>this._draw());this._cancelDrawMonitor=e.stop,ot(()=>this.callHook("drawn"))}}const ct=new Set([":","@","#","*","!","%","^","~","&","=","+",".","(",")","[","]","{","}","<",">"]);function lt(e){return"string"!=typeof e||!ct.has(e[0])&&(!/^n[:-]/.test(e)&&!/^on[:-]/.test(e))}function ut(e,t,n){const r=e.props,o=new Set(Reflect.ownKeys(t).filter(lt));for(const e of Reflect.ownKeys(r))lt(e)&&!o.has(e)&&delete r[e];for(const e of o)r[e]=t[e];e.events.updateInProps(t);const i=Object.create(null),{native:s}=e,c=Ve(e.iRender,n,i,Boolean(s));Be(i,e.slots,e.lastSlots),e.lastSlots=i,s&&(e.nativeNodes=gt(e,c,e.nativeNodes),e.mounted&&e.requestDraw())}class at extends st{constructor(e,t,n,o,i){var s,c;super(o.iRender,o,i,o.container),r(this,"component",void 0),r(this,"props",f(Object.create(null))),r(this,"slots",f(Object.create(null))),r(this,"lastSlots",void 0),r(this,"_stopRender",void 0),r(this,"nativeNodes",void 0),r(this,"shadowTree",[]),r(this,"nativeTree",[]),r(this,"_shadow",void 0),r(this,"context",void 0),r(this,"parent",void 0),this.component=e,Object.assign(this.config,e[ce]),Object.assign(this.components,e[se]),Reflect.defineProperty(this.exposed,"$component",{value:e,enumerable:!0,configurable:!0}),[this.native,this._shadow]="native"===e[re]&&(null===(s=(c=this.iRender).createComponent)||void 0===s?void 0:s.call(c))||[],this.parent=o,o.children.add(this.exposed);const l=D({slots:(u=this).slots,get created(){return u.created},get parent(){return u.parent.exposed},get children(){return u.children},get childNodes(){return u.childNodes},get emit(){return u.emit},delivered:e=>Re(u.parentDelivered,e),refresh(e){u.refresh(e)}},u.entity);var u;this.context=l,this.callHook("beforeCreate"),this.childNodes=n,E(()=>$(()=>ut(this,t,n)));const{render:a,nodes:d,stopRender:h}=function(e){const{component:t,props:n,context:r,entity:o}=e;function i(t){t&&e.refresh()}const s=_(i,()=>A(()=>t(n,r),o),{resultOnly:!0});if("function"==typeof s){const t=b(i,()=>tt(e,s()));return{nodes:t(),render:t,stopRender:()=>t.stop()}}const c=b(i,()=>tt(e,A(()=>t(n,r),o)));return{nodes:_(i,()=>tt(e,s),{resultOnly:!0}),render:c,stopRender:()=>c.stop()}}(this);this._render=a,this._stopRender=h,this._nodes=gt(this,d),this.callHook("created"),this.created=!0,this._needRefresh&&this.refresh()}_update(e,t){this.destroyed||(this.childNodes=t,E(()=>$(()=>ut(this,e,t))))}_destroy(){this._stopRender&&this._stopRender(),this.parent.children.delete(this.exposed),ft(this._nodes)}requestDraw(){this.container.markDraw(this)}_draw(){const{nativeNodes:e,iRender:t,_shadow:n,native:r}=this;r&&e&&n?(this.shadowTree=ze(t,this._nodes,this.shadowTree),this.nativeTree=ze(t,e,this.nativeTree)):this.tree=ze(t,this._nodes,this.tree)}_mount(){const{nativeNodes:e,iRender:t,_shadow:n,native:r,_nodes:o}=this;if(r&&e&&n){this.tree=ze(t,[{tag:F,key:r,value:r,children:[]}]),this.shadowTree=ze(t,o);for(const e of Se(this.shadowTree))t.insertNode(n,e);this.nativeTree=ze(t,e);for(const e of Se(this.nativeTree))t.insertNode(r,e)}else this.tree=ze(t,o)}_unmount(){const{iRender:e,nativeTree:t}=this;Ce(e,this.tree),t&&Ce(e,t)}}function dt(e){return!1===e||null==e?null:he(e)?e:{[le]:"$$$objectType$$$Element",tag:F,key:e,value:e,children:[]}}function ft(e){if(Array.isArray(e))return void e.forEach(e=>ft(e));const{component:t}=e;t&&t.destroy()}function ht(e,t,n){if(!n)return{tag:null,key:void 0,children:[]};const{tag:r}=n;if(!r)return{tag:null,key:void 0,children:[]};if($e(r)){const o=Object.create(t);return Reflect.defineProperty(o,r[de],{configurable:!0,enumerable:!0,value:n.props?n.props.value:void 0}),{...n,delivered:o,children:pt(e,o,n.children)}}if("string"!=typeof r)return"simple"===r[re]?{...n,children:pt(e,t,n.children),component:void 0}:{...n,children:[],component:new at(r,n.props||{},n.children,e,t)};const o=r.toLowerCase();if(o===L){var i;const r=null==n||null===(i=n.props)||void 0===i?void 0:i.type,o=r?l(r):e.iRender;return{...n,children:[],component:new $t(o,n.props||{},n.children,e,t)}}return o===F?{...n,children:[]}:(o.substr(0,5),{...n,children:pt(e,t,n.children)})}function pt(e,t,n){return Array.isArray(n)||(n=[n]),n.length?n.map(n=>Array.isArray(n)?[...Ae(n)].map(n=>ht(e,t,dt(n))):ht(e,t,dt(n))):[]}function yt(e,t,n,r){Array.isArray(r)||(r=[r]);const o=[];for(const i of Ae(n)){const n=dt(i);if(!n)continue;const s=r.findIndex(e=>e.tag===n.tag&&e.key===n.key);s>=0?(o.push(vt(e,t,n,r[s])),r.splice(s,1)):o.push(ht(e,t,n))}return ft(r),o}function vt(e,t,n,r){if(!r)return ht(e,t,n);if(!n)return ft(r),{tag:null,key:void 0,children:[]};if(Array.isArray(r)){if(!r.length)return ht(e,t,n);const o=r.findIndex(e=>e.tag===n.tag);if(o<0)return ft(r),ht(e,t,n);const i=r;[r]=r.splice(o,1),ft(i)}const{tag:o}=n;if(o!==r.tag)return ft(r),ht(e,t,n);if(!o)return{tag:null,key:void 0,children:[]};if($e(o)){const i=r.delivered||Object.create(t);return Reflect.defineProperty(i,o[de],{configurable:!0,enumerable:!0,value:n.props?n.props.value:void 0}),{...n,delivered:i,children:[...mt(e,i,n.children,r.children)]}}if("string"!=typeof o){if("simple"===o[re])return{...n,children:[...mt(e,t,n.children,r.children)],component:void 0};const{component:i}=r;return i?(i.update(n.props||{},n.children),{...n,children:[],component:i}):ht(e,t,n)}const i=o.toLowerCase();if(i===L){var s;const{component:o}=r;if(!o)return ht(e,t,n);const i=null==n||null===(s=n.props)||void 0===s?void 0:s.type;return(i?l(i):e.iRender)!==o.iRender?ht(e,t,n):(o.update(n.props||{},n.children),{...n,children:[],component:o})}return i===F?{...n,children:[]}:(i.substr(0,5),{...n,children:[...mt(e,t,n.children,r.children)]})}function*mt(e,t,n,r){Array.isArray(n)||(n=[n]);let o=0,i=Math.min(n.length||1,r.length);for(;o<i;o++){const i=n[o];Array.isArray(i)?yield yt(e,t,i,r[o]):yield vt(e,t,dt(i),r[o])}if(i=Math.max(n.length,n.length),r.length>o)for(;o<i;o++)ft(r[o]);if(n.length>o)for(;o<i;o++){const r=dt(n[o]);Array.isArray(r)?yield[...Ae(r)].map(n=>ht(e,t,n)):yield ht(e,t,r)}}function gt(t,n,r){return E(()=>e(()=>r?[...mt(t,t.delivered,n,r)]:pt(t,t.delivered,n)))}let _t=new Set,bt=!1;function wt(e){var t;(_t.add(e),bt)||(bt=!0,t=()=>{bt=!1;const e=[..._t];_t.clear(),e.map(e=>e.drawAll())},i(s,"The basic renderer is not installed","install"),s&&s(t))}class $t extends st{constructor(e,t,n,o,i){super(e,o,i),r(this,"props",void 0),r(this,"content",[]),r(this,"_node",null),r(this,"_container",null),r(this,"rootContainer",this),r(this,"_drawChildren",!1),r(this,"_drawContainer",!1),r(this,"_cancelDrawContainerMonitor",void 0),r(this,"_cancelDrawChildrenMonitor",void 0),r(this,"_awaitDraw",new Set),r(this,"_needDraw",!1),r(this,"_containers",new Set),this.props=t,this.parent=o,o&&(this.rootContainer=o.container.rootContainer),this.callHook("beforeCreate"),this.childNodes=n;const s=Object.create(null);this._render=b(e=>{e&&(this._drawChildren=!0,this.refresh())},()=>et(this,this.delivered,this.childNodes,s,[],!1)),this._nodes=gt(this,this._render()),this.callHook("created"),this.created=!0}setChildren(e){this.destroyed||(this.childNodes=e,this._drawChildren=!0,this.refresh())}setProps(e){this.destroyed||(this.props=e,this._drawContainer=!0,this.refresh())}update(e,t){this.refresh(()=>{this.setProps(e),this.setChildren(t)})}requestDraw(){this.markDraw(this)}_mount(){const{props:e,parent:t,iRender:n}=this,r=ze(this.container.iRender,this._nodes);this.content=r;const[o,i]=n.mount(e,null==t?void 0:t.iRender);for(const e of Se(r))n.insertNode(o,e);this.tree=[xe({tag:F,key:void 0,component:void 0,node:i,value:i,children:[]})],this._node=i,this._container=o}_destroy(){ft(this.content)}_unmount(){const{parent:e,iRender:t}=this;e&&Ce(e.iRender,this.tree),t.unmount(this._container,this._node,Boolean(e)),Ce(this.iRender,this.content)}_draw(){const{_drawChildren:e,_drawContainer:t}=this;if(this._drawContainer=!1,this._cancelDrawContainerMonitor&&this._cancelDrawContainerMonitor(),t){const e=_(e=>e&&[this._drawContainer=!0,this.requestDraw()],()=>{var e;return this.iRender.drawContainer(this._container,this._node,this.props,null===(e=this.parent)||void 0===e?void 0:e.iRender)});[this._container,this._node]=e.result,this._cancelDrawContainerMonitor=e.stop}if((!this.parent||this.parent.iRender===this.iRender)&&(this._drawChildren=!1,this._cancelDrawChildrenMonitor&&this._cancelDrawChildrenMonitor(),e)){const e=_(e=>e&&[this._drawChildren=!0,this.requestDraw()],()=>this.content=ze(this.iRender,this._nodes,this.content));this.content=e.result,this._cancelDrawChildrenMonitor=e.stop}}_drawSelf(){const{_drawChildren:e,_drawContainer:t}=this;var n;(this._needDraw=!1,this._drawChildren=!1,this._drawContainer=!1,t)&&this.iRender.drawContainer(this._container,this._node,this.props,null===(n=this.parent)||void 0===n?void 0:n.iRender,!0);e&&(this.content=ze(this.iRender,this._nodes,this.content))}drawSelf(){this.mounted&&(this.destroyed||(this.callHook("beforeDraw"),_(e=>e&&this.requestDraw(),()=>this._drawSelf()),ot(()=>this.callHook("drawn"))))}markDraw(e,t=!1){var n;(null===(n=this.parent)||void 0===n?void 0:n.iRender)!==this.iRender?(e===this&&this.parent?(this.parent.container.markDraw(this,t),this._needDraw=!t):t?this._awaitDraw.delete(e):this._awaitDraw.add(e),this.rootContainer.markDrawContainer(this,!this._needDraw&&!this._awaitDraw.size||this.destroyed)):this.parent.container.markDraw(e,t)}drawContainer(){const{_node:e,_container:t,_awaitDraw:n}=this;if(!e||!t)return;this.callHook("beforeDraw");const r=this._needDraw;this._needDraw=!1;const o=[...n];n.clear(),r&&this.drawSelf(),o.map(e=>e.draw()),this.iRender.drawNode(t,e),ot(()=>this.callHook("drawn"))}markDrawContainer(e,t=!1){t?this._containers.delete(e):this._containers.add(e),wt(this)}drawAll(){const e=this._containers;if(!e.size)return;const t=[...e];e.clear(),this.callHook("beforeDrawAll");const n=[],r=[];rt(r),je(n),t.forEach(e=>e.drawContainer()),je(),n.forEach(e=>e()),r.forEach(e=>e()),this.callHook("drawnAll")}}function Rt(e,t={}){let n={...t};const r=new $t(l(t.type),n,void 0===e?[]:he(e)?[e]:[ve(e)]),{exposed:o}=r;return Reflect.defineProperty(o,"$update",{value:e=>(r.setChildren(void 0===e?[]:he(e)?[e]:[ve(e)]),o),configurable:!0}),Reflect.defineProperty(o,"$mount",{value:e=>(o.$mounted||(e&&(n.target=e,r.setProps(n)),r.mount()),o),configurable:!0}),Reflect.defineProperty(o,"$unmount",{value(){if(o.$mounted&&!o.$unmounted)return o.$destroyed?r.destroy():void r.unmount()},configurable:!0}),n.target&&r.mount(),o}function xt(e,t){return n=>(n[e]=t,n)}function At(e,t,n){return r=>{let o=r[e];return o||(o=Object.create(null),r[e]=o),o[t]=n,r}}function kt(e,t){return t?(t[oe]=e,t):xt(oe,e)}function jt(e,t){return t?(t[re]=e,t):xt(re,e)}function Dt(e){return e?(e[re]="simple",e):xt(re,"simple")}function St(e){return e?(e[re]="native",e):xt(re,"native")}function Ct(e,t){return t?(t[ie]=e,t):xt(ie,e)}function Ot(e,t,n){const r=At(ce,e,t);return n?r(n):r}function Nt(e,t,n){const r=At(se,e,t);return n?r(n):r}function Pt(e,t){return"function"==typeof t&&(e[ie]=t),e}function Tt(e,...t){for(const n of t)n(e);return e}function Ht(e,t){const n=u(0),r=u(void 0);return Tt((function(o,{childNodes:i}){const s=r();return s?ve(s,o,...i):(async function(){if(!n()){n(1);try{const t=await e();if("function"==typeof t)return void r(t);if(!t)return void n(-1);if("function"==typeof t.default)return void r(t.default);n(-1)}catch(e){n(-1)}}}(),t?ve(t,{loading:n()>0}):null)}),Dt,kt("Lazy"))}var Et=Object.freeze({__proto__:null,install:x,Error:o,EventEmitter:q,render:Rt,register:We,lazy:Ht,version:"0.1.0-alpha.15",isProduction:!0,createDeliver:we,isDeliver:$e,ScopeSlot:K,SlotRender:z,Slot:V,Value:F,Container:L,Template:B,Fragment:U,ref:W,get value(){return u},get computed(){return a},get isValue(){return d},get encase(){return f},get recover(){return h},get valueify(){return p},get asValue(){return g},watch:X,useValue:Y,useService:Z,byService:ee,hook:te,expose:ne,isElement:he,isSimpleTag:pe,isSimpleElement:ye,createElement:ve,elements:me,equal:ge,label:_e,getRect:be,get current(){return R},checkCurrent:k,addContextConstructor:S,addEntityConstructor:O,refresh:E,mName:kt,mType:jt,mSimple:Dt,mNative:St,mRender:Ct,mConfig:Ot,mComponent:Nt,create:Pt,mark:Tt,typeSymbol:re,nameSymbol:oe,renderSymbol:ie,componentsSymbol:se,configSymbol:ce,objectTypeSymbol:le,objectTypeSymbolElement:"$$$objectType$$$Element",objectTypeSymbolDeliver:"$$$objectType$$$Deliver",deliverKeySymbol:de,deliverDefaultSymbol:fe,setHook:J,callHook:Q});export default Et;export{L as Container,o as Error,q as EventEmitter,U as Fragment,K as ScopeSlot,V as Slot,z as SlotRender,B as Template,F as Value,S as addContextConstructor,O as addEntityConstructor,g as asValue,ee as byService,Q as callHook,k as checkCurrent,se as componentsSymbol,a as computed,ce as configSymbol,Pt as create,we as createDeliver,ve as createElement,R as current,fe as deliverDefaultSymbol,de as deliverKeySymbol,me as elements,f as encase,ge as equal,ne as expose,be as getRect,te as hook,x as install,$e as isDeliver,he as isElement,n as isProduction,ye as isSimpleElement,pe as isSimpleTag,d as isValue,_e as label,Ht as lazy,Nt as mComponent,Ot as mConfig,kt as mName,St as mNative,Ct as mRender,Dt as mSimple,jt as mType,Tt as mark,oe as nameSymbol,le as objectTypeSymbol,ae as objectTypeSymbolDeliver,ue as objectTypeSymbolElement,h as recover,W as ref,E as refresh,We as register,Rt as render,ie as renderSymbol,J as setHook,re as typeSymbol,Z as useService,Y as useValue,u as value,p as valueify,t as version,X as watch};
