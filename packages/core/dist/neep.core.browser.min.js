/*!
 * Neep v0.1.0-alpha.14
 * (c) 2019-2020 Fierflame
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("monitorable")):"function"==typeof define&&define.amd?define(["exports","monitorable"],t):t((e=e||self).Neep={},e.Monitorable)}(this,(function(e,t){"use strict";function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class r extends Error{constructor(e,t=""){super(t?`[${t}] ${e}`:e),n(this,"tag",void 0),this.tag=t}}let i;function o(e){!function(e,t,n){if(!e)throw new r(t,n)}(i,"The basic renderer is not installed","install"),i&&i(e)}const s=Object.create(null);function c(e=""){return"object"==typeof e?e:s[e]||s.default}function u(t,n){const i=e.current;e.current=n;try{e.current.$_valueIndex=0,e.current.$_serviceIndex=0;const n=t();if(e.current.$_valueIndex!==e.current.$_values.length)throw new r("Inconsistent number of useValue executions","life");if(e.current.$_serviceIndex&&e.current.$_serviceIndex!==e.current.$_services.length)throw new r("Inconsistent number of useService executions","life");return n}finally{e.current=i}}function l(t,n=!1){if(!e.current)throw new r(`Function \`${t}\` can only be called within a cycle.`,"life");if(!n)return e.current;if(!e.current.created)return e.current;throw new r(`Function \`${t}\` can only be called at initialization time.`,"life")}const a=[];function d(e,t){for(const n of a)n(e,t);return e}const f=[];let h=0;const p=new Set;function y(e){return!(h<=0)&&(p.add(e),!0)}function v(){if(h>0)return;const e=[...p];p.clear(),e.forEach(e=>e.refresh())}function m(e,t){if(t)return async function(e){try{return h++,await e()}finally{h--,v()}}(e);try{return h++,e()}finally{h--,v()}}function g(e){return"@"===e[0]?e.substr(1):/^on[:-]/.test(e)?e.substr(3):/^n([:-])on(\1|:)/.test(e)?e.substr(5):""}function _(e,t){if(t)if("function"!=typeof t){if("object"==typeof t)for(const n of Object.keys(t)){const r=t[n];"function"==typeof r&&e(n,r)}}else{const{names:n}=t;if(!Array.isArray(n))return;for(const r of n)r&&e(r,(...e)=>t(r,...e))}}class b{static update(e,t){if(!t)return[];const n=[];if(t&&"object"==typeof t)for(const r of Object.keys(t)){if(!r)continue;const i=t[r];"function"==typeof i&&n.push(e.on(r,i))}return n}static updateInProps(e,t,n){if(!t)return[];const r=[];function i(t,n){r.push(e.on(t,n))}for(const e of Object.keys(t)){const n=t[e];if("function"!=typeof n)continue;const r=g(e);r&&i(r,n)}return _(i,t["@"]),_(i,t["n:on"]),_(i,t["n-on"]),"function"==typeof n&&n(i),r.push(...b.update(e,t["@"])),r}get names(){return[...this._names]}constructor(){n(this,"_names",new Set),n(this,"_cancelHandles",new Set),n(this,"emit",void 0),n(this,"on",void 0);const e=Object.create(null),r=this._names;function i(...n){function o(t,...n){const r=e[t];return!r||m(()=>{let e=!0;for(const t of[...r])e=t(...n)&&e;return e})}return o.omit=(...e)=>i(...n,...e),Reflect.defineProperty(o,"names",{get:()=>(t.markRead(i,"names"),[...r].filter(e=>!n.includes(e))),configurable:!0}),o}this.emit=i(),this.on=(n,o)=>{var s;function c(...e){try{return!1!==o(...e)}catch(e){return t.printError(e),!0}}let u=e[n];(null===(s=u)||void 0===s?void 0:s.size)||(u=new Set,e[n]=u,t.markChange(i,"names"),r.add(n)),u.add(c);let l=!1;return()=>{l||(l=!0,u.delete(c),u.size||(t.markChange(i,"names"),r.delete(n)))}}}updateHandles(e){const t=this._cancelHandles,n=[...t];t.clear();for(const e of n)e();return e.forEach(e=>t.add(e)),e}update(e){const t=b.update(this,e);return this.updateHandles(t)}updateInProps(e,t){const n=b.updateInProps(this,e,t);return this.updateHandles(n)}}const w="Neep:ScopeSlot",R="Neep:SlotRender",x="Neep:Value",k="template",A=k,S=Object.create(null);function j(e,n,r){let i=(null==r?void 0:r.$_hooks)||S;if(!i)return()=>{};n=t.safeify(n);let o=i[e];return o||(o=new Set,i[e]=o),o.add(n),()=>o.delete(n)}function C(e,t){if(t){for(const n of t.$_hooks[e]||[])n(t);for(const n of S[e]||[])n(t)}}function N(e,n,r,i){"string"==typeof n&&["$","_"].includes(n[0])||(t.isValue(r)&&i?Reflect.defineProperty(e,n,{get:()=>r(),set(e){r(e)},configurable:!0,enumerable:!0}):"function"==typeof r&&i?Reflect.defineProperty(e,n,{get:r,set:"function"==typeof i?i:void 0,configurable:!0,enumerable:!0}):Reflect.defineProperty(e,n,{get:()=>r,configurable:!0,enumerable:!0}))}const D=Symbol.for("------isNeepElement------"),O=Symbol.for("type"),$=Symbol.for("name"),P=Symbol.for("render"),H=Symbol.for("components"),I=Symbol.for("config");function E(e){return!!e&&("object"==typeof e&&!0===e[D])}function V(e,t,...n){t=t?{...t}:{};const r={[D]:!0,tag:e,key:void 0,props:t,children:n};return("n:key"in t||"n-key"in t)&&(r.key=t.key),"slot"in t&&(r.slot=t.slot),"function"==typeof t["n:ref"]?r.ref=t["n:ref"]:"function"==typeof t["n-ref"]?r.ref=t["n-ref"]:"function"==typeof t.ref&&(r.ref=t.ref),e===x&&(r.value=t.value),r}function T(e,t){if(e===t)return!0;if(!e)return!1;if(!t)return!1;if("object"!=typeof e)return!1;if("object"!=typeof t)return!1;const n=new Set(Reflect.ownKeys(e)),r=Reflect.ownKeys(t);if(n.size!==r.length)return!1;for(const i of r){if(!n.has(i))return!1;if(e[i]!==t[i])return!1}return!0}function M(e,t){if(typeof e!=typeof t)return!1;if(e===t)return!0;if("function"==typeof e)return!1;if(!e)return!1;if(!t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(let n=e.length-1;n>=0;n--)if(!M(e[n],t[n]))return!1;return!0}return!Array.isArray(t)&&(!!E(e)&&(!!E(t)&&(e.tag===t.tag&&(e.execed===t.execed&&(e.inserted===t.inserted&&(e.ref===t.ref&&(e.value===t.value&&(e.key===t.key&&(e.slot===t.slot&&(T(e.props,t.props)&&M(e.children,t.children)))))))))))}function q(e,t){return{...e,id:0}}function*z(e){if(Array.isArray(e))for(const t of e)yield*z(t);else yield e}let K;function F(e){K=e}function L(e,t,n){"function"==typeof e&&t&&(K?K.push(()=>e(t,n)):e(t,n))}function*B(e){if(Array.isArray(e)){for(const t of e)yield*B(t);return}const{children:t,node:n,component:r}=e;n?yield n:r?yield*B(r.tree):yield*B(t)}function U(e,t){if(Array.isArray(t))return void t.forEach(t=>U(e,t));const{component:n,children:r,node:i,ref:o}=t;if(n)return L(o,n.exposed,!0),void n.unmount();i&&(L(o,i,!0),e.removeNode(i)),U(e,r)}function W(e,t,n){let{ref:r}=t;if(e.isNode(n))return L(r,n),q({...t,value:n,node:n,children:[],component:void 0});const i=typeof n;let o;return"bigint"===i||"boolean"===i||"number"===i||"string"===i||"symbol"===i||n instanceof RegExp?o=e.createText(String(n)):n instanceof Date?o=e.createText(n.toISOString()):"object"===i&&n&&(o=e.createText(String(n))),o||(o=e.createPlaceholder()),L(r,o),q({...t,value:n,node:o,component:void 0,children:[]})}function G(e,t){return t.length?t.map(t=>Array.isArray(t)?J(e,t):Q(e,t)):[q({tag:null,node:e.createPlaceholder(),component:void 0,children:[]})]}function J(e,t){return t.length?t.map(t=>Q(e,t)):[q({tag:null,node:e.createPlaceholder(),component:void 0,children:[]})]}function Q(e,n){var r;const{tag:i,ref:o,component:s}=n;if(!i){const t=e.createPlaceholder();return L(o,t),q({tag:null,node:t,component:void 0,children:[]})}const c="string"!=typeof i?"":i.toLowerCase();if("string"!=typeof i||"neep:container"===c)return s?(s.mount(),L(o,s.exposed),q({...n,node:void 0,component:s,children:[]})):q({...n,node:void 0,component:void 0,children:G(e,n.children)});if("neep:value"===c){let{value:r}=n;return t.isValue(r)&&(r=r()),W(e,n,r)}if("neep:"===c.substr(0,5)||"template"===c)return q({...n,node:void 0,component:void 0,children:G(e,n.children)});const u=e.createElement(i,n.props||{});L(o,u);let l=[];if(null===(r=n.children)||void 0===r?void 0:r.length){l=G(e,n.children);for(const t of B(l))e.insertNode(u,t)}return q({...n,node:u,component:void 0,children:l})}function X(e){if(Array.isArray(e))return X(e[e.length-1]);const{component:t,children:n,node:r}=e;return r||X(t?t.tree:n)}function Y(e){if(Array.isArray(e))return Y(e[0]);const{component:t,children:n,node:r}=e;return r||Y(t?t.tree:n[0])}function Z(e,t,n){const r=Y(n);if(!r)return t;const i=e.getParent(r);if(!i)return t;for(const n of B(t))e.insertNode(i,n,r);return U(e,n),t}function ee(e,t,n){if(!t.length){return[Z(e,Q(e,{tag:null,children:[]}),n)]}Array.isArray(n)||(n=[n]);const r=[],i=[...n],o=new Map;for(const n of t){const t=i.findIndex(e=>e.tag===n.tag&&e.key===n.key);if(t>=0){const s=i[t],c=ne(e,n,s);o.set(s,c),r.push(c),i.splice(t,1)}else{const t=Q(e,n);r.push(t)}}if(!o.size)return Z(e,r,i);U(e,i);const s=X((n=n.filter(e=>o.has(e)))[n.length-1]),c=e.getParent(s);if(!c)return r;let u=e.nextNode(s);for(let t=r.length-1;t>=0;t--){const i=r[t],s=n.findIndex(e=>o.get(e)===i);if(s>=0)for(const e of n.splice(s))o.delete(e);else for(const t of B(i))e.insertNode(c,t,u);u=Y(i)||u}return r}function te(e,t,n){let r=0,i=Math.min(t.length,t.length||1);const o=[];for(;r<i;r++){const i=t[r];Array.isArray(i)?o.push(ee(e,i,n[r])):o.push(ne(e,i,n[r]))}if(i=Math.max(t.length,n.length),n.length>i)for(;r<i;r++)U(e,n[r]);if(t.length>i){const n=X(o[o.length-1]),s=e.getParent(n),c=e.nextNode(n);for(;r<i;r++){const n=t[r],i=Array.isArray(n)?J(e,n):Q(e,n);if(o.push(i),s)for(const t of B(i))e.insertNode(s,t,c)}}return o}function ne(e,n,r){if(Array.isArray(r)){const t=r.findIndex(e=>e.tag===n.tag&&e.component===n.component);if(t<0)return Z(e,Q(e,n),r);const i=r;[r]=r.splice(t,1),U(e,i)}const{tag:i,component:o}=n,s=n.ref!==r.ref&&n.ref||void 0;if(i!==r.tag||o!==r.component)return Z(e,Q(e,n),r);if(!i)return r;const c="string"!=typeof i?"":i.toLowerCase();if("string"!=typeof i||"neep:container"===c)return o?(L(s,o.exposed),q({...n,node:void 0,component:o,children:[]},r.id)):q({...n,node:void 0,component:void 0,children:te(e,n.children,r.children)},r.id);if("neep:value"===c){let{value:i}=n;return t.isValue(i)&&(i=i()),r.value===i?(L(s,r.node),q({...r,...n,value:i,children:[]},r.id)):Z(e,W(e,n,i),r)}if("neep:"===c.substr(0,5)||"template"===c)return q({...n,node:void 0,component:void 0,children:te(e,n.children,r.children)},r.id);const{node:u}=r;if(e.updateProps(u,n.props||{}),L(s,u),!n.children.length&&!r.children.length)return q({...r,...n,children:[]},r.id);if(!n.children.length&&r.children.length&&U(e,r.children),n.children.length&&!r.children.length){const t=G(e,n.children);for(const n of B(t))e.insertNode(u,n);return q({...r,...n,children:t},r.id)}return q({...r,...n,children:te(e,n.children,r.children)},r.id)}function re(e,t,n){return n?te(e,t,n):G(e,t)}function ie(e,t,n,r=!1){const i=[];for(const o of t){if(Array.isArray(o)){const t=Object.create(null);i.push(ie(e,o,t,r));for(const e of Reflect.ownKeys(t))e in n?n[e].push(t[e]):n[e]=[t[e]];continue}if(E(o)&&void 0===o.slot&&("function"==typeof o.tag&&"simple"===o.tag[O]&&o.execed||o.tag===k)){const t=Object.create(null);i.push(ie(e,o.children,t,r));for(const e of Reflect.ownKeys(t)){const r={...o,children:t[e]};e in n?n[e].push(r):n[e]=[r]}continue}if(r){if(e.isNode(o)){i.push(o);continue}if(!E(o)){i.push(o);continue}if(o.tag!==R&&o.tag!==k){i.push(o);continue}}const t=E(o)&&o.slot||"default",s=E(o)?{...o,slot:void 0,props:{...o.props,slot:void 0}}:o;t in n?n[t].push(s):n[t]=[s]}return i}function oe(e,...n){return e.map(e=>{if(Array.isArray(e))return oe(e,...n);if(!E(e))return e;if(e.tag!==R)return{...e,slot:void 0};const{children:r}=e;if(1!==(null==r?void 0:r.length))return r;const[i]=r;return t.isValue(i)||"function"!=typeof i?r:i(...n)})}function se(e,t){const n=(...e)=>({[D]:!0,tag:w,children:oe(t,...e),inserted:!0,label:void 0});return n.children=t,n}function ce(e,t=Object.create(null),n){for(const n of Reflect.ownKeys(t))n in e||delete t[n];if(!n){for(const n of Reflect.ownKeys(e))t[n]=se(0,e[n]);return t}for(const r of Reflect.ownKeys(e)){const i=e[r];M(i,n[r])||(t[r]=se(0,i))}return t}const ue=new Set([":","@","#","*","!","%","^","~","&","=","+",".","(",")","[","]","{","}","<",">"]);function le(e){return"string"!=typeof e||!ue.has(e[0])&&(!/^n[:-]/.test(e)&&!/^on[:-]/.test(e))}function ae(e,n,r={},i=!1,o=!1){const s=Reflect.ownKeys(n),c=new Set(o?s.filter(le):s);for(const t of Reflect.ownKeys(e))c.has(t)||delete e[t];if(!i){for(const t of c)e[t]=n[t];return e}for(const i of c){const o=n[i];i in r&&r[i]===o||(t.isValue(o)?Reflect.defineProperty(e,i,{configurable:!0,enumerable:!0,get:()=>o(),set(e){o(e)}}):Reflect.defineProperty(e,i,{configurable:!0,enumerable:!0,value:o}))}return e}const de=Object.create(null);function fe(e,t){if(!e)return null;if("string"!=typeof e)return e;if("template"===e)return e;if(/^neep:.+/i.test(e))return e;for(const n of t){const t=n[e];if(t)return t}return de[e]||e}function he(e,t){if(1!==e.length)return e;const[n]=e;return"function"!=typeof n?e:n(...t)}function pe(...e){return e.filter(Boolean)}function ye(e,n,r,i,o,s){if(Array.isArray(r))return r.map(t=>ye(e,n,t,i,o,s));if(!E(r))return r;let{tag:c,children:u}=r;if("Neep:Deliver"===c){const t={...r.props};return delete t.ref,delete t.slot,delete t.key,{...r,tag:c,children:u.map(r=>ye(e,ae(Object.create(n),t||{},{},!0),r,i,o,s))}}if(c===R){const c=function(e,n,r,i,o,s){if(1!==r.length)return null;const[c]=r;if(t.isValue(c)||"function"!=typeof c)return null;const{slotRenderFnList:u}=e,l=u.get(c);if(l)return l;const a=function(...t){return me(e,n,c.call(this,...t),i,o,s)};return u.set(c,a),a}(e,n,u,i,o,s);if(c)return{...r,children:[c]}}return"function"!=typeof c||"simple"!==c[O]?{...r,tag:c,children:u.map(t=>ye(e,n,t,i,o,s))}:function(e,t,n,r,i,o){if(n.execed)return n;const{iRender:s}=e,c=Object.create(null);ie(s,o,c);const u=ce(c),l=new b;l.updateInProps(n.props);const a={...n.props},f=d({slots:u,created:!1,parent:e.exposed,delivered:t,children:new Set,childNodes:o,refresh(t){e.refresh(t)},emit:l.emit}),h=r(a,f),p=me(e,t,ve(e.iRender,h,f,r[P]),u,pe(...i,r[H]),!1);return{...n,tag:r,execed:!0,children:Array.isArray(p)?p:[p],label:void 0}}(e,n,r,c,o,u)}function ve(e,t,n,r){return Array.isArray(t)?t:E(t)?[t]:null==t?[{[D]:!0,tag:null,key:void 0,children:[]}]:(!e.isNode(t)&&t&&"object"==typeof t&&r&&(t=r(t,n)),E(t)?[t]:null==t?[{[D]:!0,tag:null,key:void 0,children:[]}]:[{[D]:!0,key:void 0,tag:x,value:t,children:[]}])}function me(e,t,n,r,i,o){return ye(e,t,function e(t,n,r,i,o){var s;if(Array.isArray(t))return t.map(t=>e(t,n,r,i,o));if(!E(t))return t;let{children:c,props:u}=t,l=fe(t.tag,r);if(l===R&&o)return null;if("Neep:Slot"===l&&(l=i?"slot":w),l!==w)return{...t,tag:l,children:e(c,n,r,i,o)};if(t.tag===w&&t.inserted)return t;const a=(null==u?void 0:u.argv)&&[u.argv]||Array.isArray(null==u?void 0:u.args)&&(null==u?void 0:u.args.length)&&u.args||[{}],d=(null===(s=t.props)||void 0===s?void 0:s.name)||"default",f=n[d];return"function"==typeof f?{...t,...f(...a)}:{...t,tag:w,label:void 0,children:e(he(c,a),n,r,i,!1)}}(n,r,i,o,!0),r,i,o)}function ge(e,t){const{component:n}=e;return me(e,e.delivered,ve(e.iRender,t,e.context,n[P]),e.slots,pe(n[H]),Boolean(e.native))}let _e;function be(e){_e=e}function we(e){_e?_e.push(e):e()}function Re(e){const t={exposed:{configurable:!0,get:()=>e.exposed},delivered:{configurable:!0,get:()=>e.delivered},parent:{configurable:!0,get:()=>{var t;return null===(t=e.parent)||void 0===t?void 0:t.entity}},component:{configurable:!0,value:null},isContainer:{configurable:!0,value:!1},created:{configurable:!0,get:()=>e.created},destroyed:{configurable:!0,get:()=>e.destroyed},mounted:{configurable:!0,get:()=>e.mounted},unmounted:{configurable:!0,get:()=>e.unmounted},$_hooks:{configurable:!0,value:Object.create(null)},$_valueIndex:{configurable:!0,value:0,writable:!0},$_values:{configurable:!0,value:[]},$_serviceIndex:{configurable:!0,value:0,writable:!0},$_services:{configurable:!0,value:[]},callHook:{configurable:!0,value(e){C(e,n)}},setHook:{configurable:!0,value:(e,t)=>j(e,t,n)},refresh:{configurable:!0,value:e.refresh.bind(e)},on:{configurable:!0,value:e.on},emit:{configurable:!0,value:e.emit},config:{configurable:!0,value:e.config}},n=Object.create(null,t);return function(e){for(const t of f)t(e);return e}(n)}class xe{constructor(e,t,r=(null==t?void 0:t.delivered)||Object.create(null),i){n(this,"slotRenderFnList",new WeakMap),n(this,"events",new b),n(this,"emit",this.events.emit),n(this,"on",this.events.on),n(this,"eventCancelHandles",new Set),n(this,"iRender",void 0),n(this,"components",Object.create(null)),n(this,"config",Object.create(null)),n(this,"parentDelivered",void 0),n(this,"delivered",void 0),n(this,"exposed",function(e){const t={$parent:{configurable:!0,get:()=>{var t;return null===(t=e.parent)||void 0===t?void 0:t.exposed}},$component:{configurable:!0,value:null},$isContainer:{configurable:!0,value:!1},$created:{configurable:!0,get:()=>e.created},$destroyed:{configurable:!0,get:()=>e.destroyed},$mounted:{configurable:!0,get:()=>e.mounted},$unmounted:{configurable:!0,get:()=>e.unmounted}};return Object.create(null,t)}(this)),n(this,"entity",Re(this)),n(this,"parent",void 0),n(this,"native",void 0),n(this,"created",!1),n(this,"destroyed",!1),n(this,"mounted",!1),n(this,"unmounted",!1),n(this,"children",new Set),n(this,"tree",[]),n(this,"container",void 0),n(this,"_render",()=>[]),n(this,"_needRefresh",!1),n(this,"_delayedRefresh",0),n(this,"_refreshing",!1),n(this,"_nodes",[]),n(this,"childNodes",[]),n(this,"__executed_destroy",!1),n(this,"__executed_mount",!1),n(this,"__executed_mounted",!1),n(this,"_cancelDrawMonitor",void 0),this.iRender=e,this.parentDelivered=r,this.delivered=Object.create(r),t&&(this.parent=t),this.container=i||this}get canRefresh(){return!y(this)&&!this._delayedRefresh}get needRefresh(){if(y(this))return!1;if(this._delayedRefresh)return!1;const e=this._needRefresh;return this._needRefresh=!1,e}requestDraw(){}async asyncRefresh(e){try{return this._delayedRefresh++,await e()}finally{this._delayedRefresh--,this.refresh()}}refresh(e,t){if("function"==typeof e){if(t)return this.asyncRefresh(e);try{return this._delayedRefresh++,e()}finally{this._delayedRefresh--,this._delayedRefresh<=0&&this.refresh()}}if(this.destroyed)return;if(this._needRefresh=!0,!this.created)return;if(this._refreshing)return;let n;for(this._refreshing=!0;this.needRefresh;)if(n=this._render(),this.destroyed)return;this._refreshing=!1,this.canRefresh&&n&&(this._nodes=Pe(this,n,this._nodes),this.mounted&&(this.destroyed||this.unmounted||this.requestDraw()))}callHook(e){C(e,this.entity)}_update(e,t){this.childNodes=t}update(e,t){this._update(e,t)}_destroy(){}destroy(){this.__executed_destroy||(this.__executed_destroy=!0,this.callHook("beforeDestroy"),this._destroy(),this.callHook("destroyed"),this.destroyed=!0)}_mount(){}mount(){if(this.__executed_destroy)return;if(this.__executed_mount)return;this.__executed_mount=!0,this.callHook("beforeMount");const e=t.exec(e=>e&&this.requestDraw(),()=>{this._mount(),this.mounted=!0});this._cancelDrawMonitor=e.stop,we(()=>this.callHook("mounted"))}_unmount(){}unmount(){this.mounted&&(this.__executed_mounted||(this.__executed_mounted=!0,this.callHook("beforeUnmount"),this._unmount(),this.callHook("unmounted"),this.unmounted=!0))}_draw(){}draw(){if(this.__executed_destroy)return;this._cancelDrawMonitor&&this._cancelDrawMonitor(),this.callHook("beforeDraw");const e=t.exec(e=>e&&this.requestDraw(),()=>this._draw());this._cancelDrawMonitor=e.stop,we(()=>this.callHook("drawn"))}}function ke(e,t,n){ae(e.props,t,{},!1,!0),e.events.updateInProps(t);const r=Object.create(null),{native:i}=e,o=ie(e.iRender,n,r,Boolean(i));ce(r,e.slots,e.lastSlots),e.lastSlots=r,i&&(e.nativeNodes=Pe(e,o,e.nativeNodes),e.mounted&&e.requestDraw())}class Ae extends xe{constructor(e,r,i,o,s){var c,l;super(o.iRender,o,s,o.container),n(this,"component",void 0),n(this,"props",t.encase(Object.create(null))),n(this,"slots",t.encase(Object.create(null))),n(this,"lastSlots",void 0),n(this,"_stopRender",void 0),n(this,"nativeNodes",void 0),n(this,"shadowTree",[]),n(this,"nativeTree",[]),n(this,"_shadow",void 0),n(this,"context",void 0),n(this,"parent",void 0),this.component=e,Object.assign(this.config,e[I]),Object.assign(this.components,e[H]),Reflect.defineProperty(this.exposed,"$component",{value:e,enumerable:!0,configurable:!0}),[this.native,this._shadow]="native"===e[O]&&(null===(c=(l=this.iRender).createComponent)||void 0===c?void 0:c.call(l))||[],this.parent=o,o.children.add(this.exposed);const a=d({slots:(f=this).slots,get created(){return f.created},get parent(){return f.parent.exposed},get delivered(){return f.parentDelivered},get children(){return f.children},get childNodes(){return f.childNodes},get emit(){return f.emit},refresh(e){f.refresh(e)}},f.entity);var f;this.context=a,this.callHook("beforeCreate"),this.childNodes=i,m(()=>ke(this,r,i));const{render:h,nodes:p,stopRender:y}=function(e){const{component:n,props:r,context:i,entity:o}=e;function s(t){t&&e.refresh()}const c=t.exec(s,()=>u(()=>n(r,i),o),{resultOnly:!0});if("function"==typeof c){const n=t.monitor(s,()=>ge(e,c()));return{nodes:n(),render:n,stopRender:()=>n.stop()}}const l=t.monitor(s,()=>ge(e,u(()=>n(r,i),o)));return{nodes:t.exec(s,()=>ge(e,c),{resultOnly:!0}),render:l,stopRender:()=>l.stop()}}(this);this._render=h,this._stopRender=y,this._nodes=Pe(this,p),this.callHook("created"),this.created=!0,this._needRefresh&&this.refresh()}_update(e,t){this.destroyed||(this.childNodes=t,m(()=>ke(this,e,t)))}_destroy(){this._stopRender&&this._stopRender(),this.parent.children.delete(this.exposed),je(this._nodes)}requestDraw(){this.container.markDraw(this)}_draw(){const{nativeNodes:e,iRender:t,_shadow:n,native:r}=this;r&&e&&n?(this.shadowTree=re(t,this._nodes,this.shadowTree),this.nativeTree=re(t,e,this.nativeTree)):this.tree=re(t,this._nodes,this.tree)}_mount(){const{nativeNodes:e,iRender:t,_shadow:n,native:r,_nodes:i}=this;if(r&&e&&n){this.tree=re(t,Pe(this,r)),this.shadowTree=re(t,i);for(const e of B(this.shadowTree))t.insertNode(n,e);this.nativeTree=re(t,e);for(const e of B(this.nativeTree))t.insertNode(r,e)}else this.tree=re(t,i)}_unmount(){const{iRender:e,nativeTree:t}=this;U(e,this.tree),t&&U(e,t)}}function Se(e){return!1===e||null==e?null:E(e)?e:{[D]:!0,tag:"Neep:Value",key:e,value:e,children:[]}}function je(e){if(Array.isArray(e))return void e.forEach(e=>je(e));const{component:t}=e;t&&t.destroy()}function Ce(e,t,n){if(!n)return{tag:null,key:void 0,children:[]};const{tag:r}=n;if(!r)return{tag:null,key:void 0,children:[]};if("string"!=typeof r)return"simple"===r[O]?{...n,children:Ne(e,t,n.children),component:void 0}:{...n,children:[],component:new Ae(r,n.props||{},n.children,e,t)};const i=r.toLowerCase();if("neep:container"===i){var o;const r=null==n||null===(o=n.props)||void 0===o?void 0:o.type,i=r?c(r):e.iRender;return{...n,children:[],component:new Ee(i,n.props||{},n.children,e,t)}}if("neep:value"===i)return{...n,children:[]};if("neep:deliver"===i){const r={...n.props};delete r.ref,delete r.slot,delete r.key;const i=ae(Object.create(t),r,{},!0);return{...n,delivered:i,children:Ne(e,i,n.children)}}return i.substr(0,5),{...n,children:Ne(e,t,n.children)}}function Ne(e,t,n){return Array.isArray(n)||(n=[n]),n.length?n.map(n=>Array.isArray(n)?[...z(n)].map(n=>Ce(e,t,Se(n))):Ce(e,t,Se(n))):[]}function De(e,t,n,r){Array.isArray(r)||(r=[r]);const i=[];for(const o of z(n)){const n=Se(o);if(!n)continue;const s=r.findIndex(e=>e.tag===n.tag&&e.key===n.key);s>=0?(i.push(Oe(e,t,n,r[s])),r.splice(s,1)):i.push(Ce(e,t,n))}return je(r),i}function Oe(e,t,n,r){if(!r)return Ce(e,t,n);if(!n)return je(r),{tag:null,key:void 0,children:[]};if(Array.isArray(r)){if(!r.length)return Ce(e,t,n);const i=r.findIndex(e=>e.tag===n.tag);if(i<0)return je(r),Ce(e,t,n);const o=r;[r]=r.splice(i,1),je(o)}const{tag:i}=n;if(i!==r.tag)return je(r),Ce(e,t,n);if(!i)return{tag:null,key:void 0,children:[]};if("string"!=typeof i){if("simple"===i[O])return{...n,children:[...$e(e,t,n.children,r.children)],component:void 0};const{component:o}=r;return o?(o.update(n.props||{},n.children),{...n,children:[],component:o}):Ce(e,t,n)}const o=i.toLowerCase();if("neep:container"===o){var s;const{component:i}=r;if(!i)return Ce(e,t,n);const o=null==n||null===(s=n.props)||void 0===s?void 0:s.type;return(o?c(o):e.iRender)!==i.iRender?Ce(e,t,n):(i.update(n.props||{},n.children),{...n,children:[],component:i})}if("neep:value"===o)return{...n,children:[]};if("neep:deliver"===o){const i={...n.props};delete i.ref,delete i.slot,delete i.key;const o=ae(r.delivered||Object.create(t),i,r.props,!0);return{...n,delivered:o,children:[...$e(e,o,n.children,r.children)]}}return o.substr(0,5),{...n,children:[...$e(e,t,n.children,r.children)]}}function*$e(e,t,n,r){Array.isArray(n)||(n=[n]);let i=0,o=Math.min(n.length,n.length);for(;i<o;i++){const o=n[i];Array.isArray(o)?yield De(e,t,o,r[i]):yield Oe(e,t,Se(o),r[i])}if(o=Math.max(n.length,n.length),r.length>o)for(;i<o;i++)je(r[i]);if(n.length>o)for(;i<o;i++){const r=Se(n[i]);Array.isArray(r)?yield[...z(r)].map(n=>Ce(e,t,n)):yield Ce(e,t,r)}}function Pe(e,t,n){return n?[...$e(e,e.delivered,t,n)]:Ne(e,e.delivered,t)}let He=new Set,Ie=!1;class Ee extends xe{constructor(e,r,i,o,s){super(e,o,s),n(this,"props",void 0),n(this,"content",[]),n(this,"_node",null),n(this,"_container",null),n(this,"rootContainer",this),n(this,"_drawChildren",!1),n(this,"_drawContainer",!1),n(this,"_awaitDraw",new Set),n(this,"_needDraw",!1),n(this,"_containers",new Set),this.props=r,this.parent=o,o&&(this.rootContainer=o.container.rootContainer),this.callHook("beforeCreate"),this.childNodes=i;const c=Object.create(null);this._render=t.monitor(e=>{e&&(this._drawChildren=!0,this.refresh())},()=>me(this,this.delivered,this.childNodes,c,[],!1)),this._nodes=Pe(this,this._render()),this.callHook("created"),this.created=!0}setChildren(e){this.destroyed||(this.childNodes=e,this._drawChildren=!0,this.refresh())}setProps(e){this.destroyed||(this.props=e,this._drawContainer=!0,this.refresh())}update(e,t){this.refresh(()=>{this.setProps(e),this.setChildren(t)})}requestDraw(){this.markDraw(this)}_mount(){const{props:e,parent:t,iRender:n}=this,r=re(this.container.iRender,this._nodes);this.content=r;const[i,o]=n.mount(e,null==t?void 0:t.iRender);for(const e of B(r))n.insertNode(i,e);this.tree=[q({tag:x,key:void 0,component:void 0,node:o,value:o,children:[]})],this._node=o,this._container=i}_destroy(){je(this.content)}_unmount(){const{parent:e,iRender:t}=this;e&&U(e.iRender,this.tree),t.unmount(this._container,this._node,Boolean(e)),U(this.iRender,this.content)}_draw(){const{_drawChildren:e,_drawContainer:t}=this;var n;(this._drawContainer=!1,t)&&this.iRender.drawContainer(this._container,this._node,this.props,null===(n=this.parent)||void 0===n?void 0:n.iRender);this.parent&&this.parent.iRender!==this.iRender||(this._drawChildren=!1,e&&(this.content=re(this.iRender,this._nodes,this.content)))}_drawSelf(){const{_drawChildren:e,_drawContainer:t}=this;var n;(this._needDraw=!1,this._drawChildren=!1,this._drawContainer=!1,t)&&this.iRender.drawContainer(this._container,this._node,this.props,null===(n=this.parent)||void 0===n?void 0:n.iRender,!0);e&&(this.content=re(this.iRender,this._nodes,this.content))}drawSelf(){this.mounted&&(this.destroyed||(this.callHook("beforeDraw"),t.exec(e=>e&&this.markDraw(this),()=>this._drawSelf()),we(()=>this.callHook("drawn"))))}markDraw(e,t=!1){var n;(null===(n=this.parent)||void 0===n?void 0:n.iRender)!==this.iRender?(e===this&&this.parent?(this.parent.container.markDraw(this,t),this._needDraw=!t):t?this._awaitDraw.delete(e):this._awaitDraw.add(e),this.rootContainer.markDrawContainer(this,!this._needDraw&&!this._awaitDraw.size||this.destroyed)):this.parent.container.markDraw(e,t)}drawContainer(){const{_node:e,_container:t,_awaitDraw:n}=this;if(!e||!t)return;this.callHook("beforeDraw");const r=this._needDraw;this._needDraw=!1;const i=[...n];n.clear(),r&&this.drawSelf(),i.map(e=>e.draw()),this.iRender.drawNode(t,e),we(()=>this.callHook("drawn"))}markDrawContainer(e,t=!1){var n;t?this._containers.delete(e):this._containers.add(e),n=this,He.add(n),Ie||(Ie=!0,o(()=>{Ie=!1;const e=[...He];He.clear(),e.map(e=>e.drawAll())}))}drawAll(){const e=this._containers;if(!e.size)return;this.callHook("beforeDrawAll");const t=[],n=[];be(n),F(t);const r=[...e];e.clear(),r.forEach(e=>e.drawContainer()),F(),t.forEach(e=>e()),n.forEach(e=>e()),this.callHook("drawnAll")}}function Ve(e,t){return n=>(n[e]=t,n)}function Te(e,t,n){return r=>{let i=r[e];return i||(i=Object.create(null),r[e]=i),i[t]=n,r}}function Me(e,t){return t?(t[$]=e,t):Ve($,e)}function qe(e){return e?(e[O]="simple",e):Ve(O,"simple")}function ze(e,...t){for(const n of t)n(e);return e}Object.defineProperty(e,"asValue",{enumerable:!0,get:function(){return t.asValue}}),Object.defineProperty(e,"computed",{enumerable:!0,get:function(){return t.computed}}),Object.defineProperty(e,"encase",{enumerable:!0,get:function(){return t.encase}}),Object.defineProperty(e,"isValue",{enumerable:!0,get:function(){return t.isValue}}),Object.defineProperty(e,"recover",{enumerable:!0,get:function(){return t.recover}}),Object.defineProperty(e,"value",{enumerable:!0,get:function(){return t.value}}),Object.defineProperty(e,"valueify",{enumerable:!0,get:function(){return t.valueify}}),e.Container="Neep:Container",e.Deliver="Neep:Deliver",e.Error=r,e.EventEmitter=b,e.Fragment=A,e.ScopeSlot=w,e.Slot="Neep:Slot",e.SlotRender=R,e.Template=k,e.Value=x,e.addContextConstructor=function(e){a.push(t.safeify(e))},e.addEntityConstructor=function(e){f.push(t.safeify(e))},e.byService=function(e,...t){return e(l("byService"),...t)},e.callHook=C,e.checkCurrent=l,e.componentsSymbol=H,e.configSymbol=I,e.create=function(e,t){return"function"==typeof t&&(e[P]=t),e},e.createElement=V,e.deliver=function(e,t,n){N(l("deliver",!0).delivered,e,t,n)},e.elements=function e(t,n={}){if(Array.isArray(t)){const r=[];for(let i of t)r.push(e(i,n));return[].concat(...r)}if(!E(t))return[t];let{tag:r}=t;if(!r)return[t];if([k,w].includes(r))return e(t.children,n);if("function"!=typeof r)return[t];if("simple"!==r[O])return[t];const{simple:i=!0}=n;if(!i)return[t];if(Array.isArray(i)){if(i.includes(r))return[t]}else if("function"==typeof i&&!i(r))return[t];return e(t.children,n)},e.equal=M,e.equalProps=T,e.expose=function(e,t,n){N(l("expose",!0).exposed,e,t,n)},e.getRect=function(e){for(const t of Object.keys(s)){const n=s[t];if(!n)continue;if(!n.isNode(e))continue;const r=n.getRect(e);if(r)return r}return null},e.hook=function(e,t,n){const r=l("setHook");if(!n||!r.created)return j(e,()=>t(),r)},e.install=function(e){e.monitorable,function(e){e&&(s[e.type]=e,i||(s.default||(s.default=e),!i&&e.nextFrame&&(s.default=e,i=e.nextFrame)))}(e.render)},e.isElement=E,e.isElementSymbol=D,e.isProduction=!0,e.label=function(e,t=""){},e.lazy=function(e,n){const r=t.value(0),i=t.value(void 0);return ze((function(t,{childNodes:o}){const s=i();return s?V(s,t,...o):(async function(){if(!r()){r(1);try{const t=await e();if("function"==typeof t)return void i(t);if(!t)return void r(-1);if("function"==typeof t.default)return void i(t.default);r(-1)}catch(e){r(-1)}}}(),n?V(n,{loading:r()>0}):null)}),qe,Me("Lazy"))},e.mComponent=function(e,t,n){const r=Te(H,e,t);return n?r(n):r},e.mConfig=function(e,t,n){const r=Te(I,e,t);return n?r(n):r},e.mName=Me,e.mNative=function(e){return e?(e[O]="native",e):Ve(O,"native")},e.mRender=function(e,t){return t?(t[P]=e,t):Ve(P,e)},e.mSimple=qe,e.mType=function(e,t){return t?(t[O]=e,t):Ve(O,e)},e.mark=ze,e.nameSymbol=$,e.refresh=m,e.register=function(e,t){de[e]=t},e.render=function(e,t={}){let n={...t};const r=new Ee(c(t.type),n,void 0===e?[]:E(e)?[e]:[V(e)]),{exposed:i}=r;return Reflect.defineProperty(i,"$update",{value:e=>(r.setChildren(void 0===e?[]:E(e)?[e]:[V(e)]),i),configurable:!0}),Reflect.defineProperty(i,"$mount",{value:e=>(i.$mounted||(e&&(n.target=e,r.setProps(n)),r.mount()),i),configurable:!0}),Reflect.defineProperty(i,"$unmount",{value(){if(i.$mounted&&!i.$unmounted)return i.$destroyed?r.destroy():void r.unmount()},configurable:!0}),n.target&&r.mount(),i},e.renderSymbol=P,e.setHook=j,e.typeSymbol=O,e.useService=function(e,...t){const n=l("useService"),i=n.$_serviceIndex++,o=n.$_services;if(!n.created){o[i]=void 0;const r=e(n,...t);return o[i]=r,r}if(i>=o.length)throw new r("Inconsistent number of useService executions","life");return o[i]},e.useValue=function(e){const n=l("useValue"),i=n.$_valueIndex++,o=n.$_values;if(!n.created){o[i]=void 0;const n="function"==typeof e?e():t.value(void 0);return o[i]=n}if(i>=o.length)throw new r("Inconsistent number of useValue executions","life");return o[i]},e.version="0.1.0-alpha.14",e.watch=function(e,n){const r=l("watch");if("function"!=typeof e)return()=>{};const i=t.isValue(e)?e.watch(n):t.computed(e).watch((e,t)=>n(e(),t));return j("beforeDestroy",()=>i(),r),i},Object.defineProperty(e,"__esModule",{value:!0})}));
